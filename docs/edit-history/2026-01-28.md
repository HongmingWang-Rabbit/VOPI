# Edit History - January 28, 2026

## Session Summary

This session had two parts:

**Part 1** extended **product metadata** with demographics, style, and platform-specific fields. All three platform formatters (Shopify, Amazon, eBay), both Gemini prompts (audio and unified video), both providers, the PATCH API, and the Zod schema were updated. Tests and documentation were also added.

**Part 2** added **product context injection into Gemini lifestyle prompts** and fixed **job deletion not cleaning up uploaded videos** from the `uploads/` S3 prefix.

### Major Changes (Part 1)

1. **New ProductMetadata fields** - `gender`, `targetAudience`, `ageGroup`, `style`, `modelNumber` added to interface, Zod schema, Gemini prompts, and both providers
2. **Amazon SP-API fields** - `standard_price`, `department`, `target_audience_keyword`, `age_range_description`, `model_number`, `style`, `size`, `pattern`
3. **eBay fields** - `pricingSummary` for fixed-price listings; `Gender`, `Style`, `Age Group`, `Pattern` aspects
4. **Shopify metafields** - `materials`, `care_instructions`, `gender` as custom metafields
5. **PATCH metadata endpoint** - 11 new editable fields: `gender`, `targetAudience`, `ageGroup`, `style`, `modelNumber`, `compareAtPrice`, `costPerItem`, `countryOfOrigin`, `manufacturer`, `pattern`, `productType`
6. **Currency default** - `formatForAmazon` and `formatForEbay` now default currency to `USD` when not specified
7. **Tests** - 13 new tests covering all new formatter behavior and Zod schema validation
8. **Front-end changelog** - `2026-01-28-product-metadata-fields.md` (v2.1.0)

### Major Changes (Part 2)

1. **Gemini lifestyle prompt product context** - `getImageGeneratePrompt()` now accepts optional `productContext` (title, description, category) and injects a `## PRODUCT CONTEXT` section into the lifestyle prompt so Gemini generates contextually appropriate scenes instead of generic backgrounds
2. **Structural prompt composition** - Lifestyle prompt refactored from a single constant into composable parts (`LIFESTYLE_PROMPT_BASE`, `LIFESTYLE_BACKGROUND_GENERIC`, `LIFESTYLE_PROMPT_FOOTER`) to avoid fragile string replacement
3. **Job deletion uploaded video cleanup** - `DELETE /jobs/:id` now also deletes the uploaded video from the `uploads/` S3 prefix (previously only `jobs/{id}/` was cleaned up)
4. **Shared `deleteUploadedVideo()` method** - Extracted duplicate uploaded-video cleanup logic from `pipeline.service.ts` and `jobs.controller.ts` into `storageService.deleteUploadedVideo()` — single best-effort method used by both callers

---

## Files Modified

### Types

| File | Changes |
|------|---------|
| `src/types/product-metadata.types.ts` | - Added 5 demographics fields to `ProductMetadata` interface |
|                                         | - Added 8 fields to `AmazonListingInput` |
|                                         | - Added `pricingSummary` to `EbayListingInput` |
|                                         | - Added 5 fields to `geminiAudioAnalysisResponseSchema` Zod schema |
|                                         | - `formatForShopify()`: added metafields for materials, care_instructions, gender |
|                                         | - `formatForAmazon()`: maps demographics, pricing, style fields |
|                                         | - `formatForEbay()`: maps demographics to aspects, adds pricingSummary |
|                                         | - Fixed: currency defaults to `USD` in Amazon and eBay formatters |

### Tests

| File | Changes |
|------|---------|
| `src/types/product-metadata.test.ts` | - 13 new tests for Shopify metafields, Amazon demographics/pricing, eBay aspects/pricing, Zod demographics fields |

### Providers

| File | Changes |
|------|---------|
| `src/providers/implementations/gemini-audio-analysis.provider.ts` | - `convertToResult()`: maps `gender`, `targetAudience`, `ageGroup`, `style`, `modelNumber` via `nullToUndefined()` |
| `src/providers/implementations/gemini-unified-video-analyzer.provider.ts` | - Added 5 fields to `GeminiUnifiedVideoResponse` interface |
|                                                                             | - `convertAudioAnalysis()`: maps snake_case fields to camelCase ProductMetadata |

### Prompts

| File | Changes |
|------|---------|
| `src/templates/gemini-audio-analysis-prompt.ts` | - Added `gender`, `targetAudience`, `ageGroup`, `style`, `modelNumber` to JSON example (camelCase) |
| `src/templates/gemini-unified-video-prompt.ts` | - Added `gender`, `target_audience`, `age_group`, `style`, `model_number` to JSON example (snake_case) |

### Routes

| File | Changes |
|------|---------|
| `src/routes/jobs.routes.ts` | - `updateProductMetadataSchema`: added 11 new Zod fields |
|                               | - Fastify JSON schema: added matching 11 fields for Swagger docs |

### Documentation

| File | Changes |
|------|---------|
| `docs/front-end-integration/api-changelog/2026-01-28-product-metadata-fields.md` | - New changelog entry (v2.1.0) |
| `docs/front-end-integration/api-changelog/README.md` | - Added v2.1.0 to index |

### Part 2 — Prompt Context & Job Deletion Fix

#### Templates

| File | Changes |
|------|---------|
| `src/templates/gemini-image-generate-prompts.ts` | - `getImageGeneratePrompt()` accepts optional `productContext` param |
|                                                    | - Lifestyle prompt split into composable parts (`LIFESTYLE_PROMPT_BASE`, `LIFESTYLE_BACKGROUND_GENERIC`, `LIFESTYLE_PROMPT_FOOTER`) |
|                                                    | - New `buildLifestylePrompt()` injects `## PRODUCT CONTEXT` section with title, category, truncated description |

#### Providers

| File | Changes |
|------|---------|
| `src/providers/implementations/gemini-image-generate.provider.ts` | - Passes `productTitle`, `productDescription`, `productCategory` to `getImageGeneratePrompt()` |
|                                                                     | - Updated comment to reflect product context injection |

#### Services

| File | Changes |
|------|---------|
| `src/services/storage.service.ts` | - New `deleteUploadedVideo(videoUrl)` method: best-effort delete of `uploads/` prefix videos |
| `src/services/pipeline.service.ts` | - `cleanupUploadedVideo()` now delegates to `storageService.deleteUploadedVideo()` |
|                                      | - Removed unused `extractS3KeyFromUrl` import |

#### Controllers

| File | Changes |
|------|---------|
| `src/controllers/jobs.controller.ts` | - `deleteJob()` calls `storageService.deleteUploadedVideo()` after prefix deletion |
