# Edit History - January 28, 2026

## Session Summary

This session had three parts:

**Part 1** extended **product metadata** with demographics, style, and platform-specific fields. All three platform formatters (Shopify, Amazon, eBay), both Gemini prompts (audio and unified video), both providers, the PATCH API, and the Zod schema were updated. Tests and documentation were also added.

**Part 2** added **product context injection into Gemini lifestyle prompts** and fixed **job deletion not cleaning up uploaded videos** from the `uploads/` S3 prefix.

**Part 3** enhanced **platform OAuth flow** with an unauthenticated success page, hardened open redirect prevention, upgraded **Shopify** to `productSet` mutation (API version `2026-01`), added a **platform availability** endpoint, and added `trustProxy` for correct protocol detection behind reverse proxy.

### Major Changes (Part 1)

1. **New ProductMetadata fields** - `gender`, `targetAudience`, `ageGroup`, `style`, `modelNumber` added to interface, Zod schema, Gemini prompts, and both providers
2. **Amazon SP-API fields** - `standard_price`, `department`, `target_audience_keyword`, `age_range_description`, `model_number`, `style`, `size`, `pattern`
3. **eBay fields** - `pricingSummary` for fixed-price listings; `Gender`, `Style`, `Age Group`, `Pattern` aspects
4. **Shopify metafields** - `materials`, `care_instructions`, `gender` as custom metafields
5. **PATCH metadata endpoint** - 11 new editable fields: `gender`, `targetAudience`, `ageGroup`, `style`, `modelNumber`, `compareAtPrice`, `costPerItem`, `countryOfOrigin`, `manufacturer`, `pattern`, `productType`
6. **Currency default** - `formatForAmazon` and `formatForEbay` now default currency to `USD` when not specified
7. **Tests** - 13 new tests covering all new formatter behavior and Zod schema validation
8. **Front-end changelog** - `2026-01-28-product-metadata-fields.md` (v2.1.0)

### Major Changes (Part 2)

1. **Gemini lifestyle prompt product context** - `getImageGeneratePrompt()` now accepts optional `productContext` (title, description, category) and injects a `## PRODUCT CONTEXT` section into the lifestyle prompt so Gemini generates contextually appropriate scenes instead of generic backgrounds
2. **Structural prompt composition** - Lifestyle prompt refactored from a single constant into composable parts (`LIFESTYLE_PROMPT_BASE`, `LIFESTYLE_BACKGROUND_GENERIC`, `LIFESTYLE_PROMPT_FOOTER`) to avoid fragile string replacement
3. **Job deletion uploaded video cleanup** - `DELETE /jobs/:id` now also deletes the uploaded video from the `uploads/` S3 prefix (previously only `jobs/{id}/` was cleaned up)
4. **Shared `deleteUploadedVideo()` method** - Extracted duplicate uploaded-video cleanup logic from `pipeline.service.ts` and `jobs.controller.ts` into `storageService.deleteUploadedVideo()` — single best-effort method used by both callers

---

## Files Modified

### Types

| File | Changes |
|------|---------|
| `src/types/product-metadata.types.ts` | - Added 5 demographics fields to `ProductMetadata` interface |
|                                         | - Added 8 fields to `AmazonListingInput` |
|                                         | - Added `pricingSummary` to `EbayListingInput` |
|                                         | - Added 5 fields to `geminiAudioAnalysisResponseSchema` Zod schema |
|                                         | - `formatForShopify()`: added metafields for materials, care_instructions, gender |
|                                         | - `formatForAmazon()`: maps demographics, pricing, style fields |
|                                         | - `formatForEbay()`: maps demographics to aspects, adds pricingSummary |
|                                         | - Fixed: currency defaults to `USD` in Amazon and eBay formatters |

### Tests

| File | Changes |
|------|---------|
| `src/types/product-metadata.test.ts` | - 13 new tests for Shopify metafields, Amazon demographics/pricing, eBay aspects/pricing, Zod demographics fields |

### Providers

| File | Changes |
|------|---------|
| `src/providers/implementations/gemini-audio-analysis.provider.ts` | - `convertToResult()`: maps `gender`, `targetAudience`, `ageGroup`, `style`, `modelNumber` via `nullToUndefined()` |
| `src/providers/implementations/gemini-unified-video-analyzer.provider.ts` | - Added 5 fields to `GeminiUnifiedVideoResponse` interface |
|                                                                             | - `convertAudioAnalysis()`: maps snake_case fields to camelCase ProductMetadata |

### Prompts

| File | Changes |
|------|---------|
| `src/templates/gemini-audio-analysis-prompt.ts` | - Added `gender`, `targetAudience`, `ageGroup`, `style`, `modelNumber` to JSON example (camelCase) |
| `src/templates/gemini-unified-video-prompt.ts` | - Added `gender`, `target_audience`, `age_group`, `style`, `model_number` to JSON example (snake_case) |

### Routes

| File | Changes |
|------|---------|
| `src/routes/jobs.routes.ts` | - `updateProductMetadataSchema`: added 11 new Zod fields |
|                               | - Fastify JSON schema: added matching 11 fields for Swagger docs |

### Documentation

| File | Changes |
|------|---------|
| `docs/front-end-integration/api-changelog/2026-01-28-product-metadata-fields.md` | - New changelog entry (v2.1.0) |
| `docs/front-end-integration/api-changelog/README.md` | - Added v2.1.0 to index |

### Part 2 — Prompt Context & Job Deletion Fix

#### Templates

| File | Changes |
|------|---------|
| `src/templates/gemini-image-generate-prompts.ts` | - `getImageGeneratePrompt()` accepts optional `productContext` param |
|                                                    | - Lifestyle prompt split into composable parts (`LIFESTYLE_PROMPT_BASE`, `LIFESTYLE_BACKGROUND_GENERIC`, `LIFESTYLE_PROMPT_FOOTER`) |
|                                                    | - New `buildLifestylePrompt()` injects `## PRODUCT CONTEXT` section with title, category, truncated description |

#### Providers

| File | Changes |
|------|---------|
| `src/providers/implementations/gemini-image-generate.provider.ts` | - Passes `productTitle`, `productDescription`, `productCategory` to `getImageGeneratePrompt()` |
|                                                                     | - Updated comment to reflect product context injection |

#### Services

| File | Changes |
|------|---------|
| `src/services/storage.service.ts` | - New `deleteUploadedVideo(videoUrl)` method: best-effort delete of `uploads/` prefix videos |
| `src/services/pipeline.service.ts` | - `cleanupUploadedVideo()` now delegates to `storageService.deleteUploadedVideo()` |
|                                      | - Removed unused `extractS3KeyFromUrl` import |

#### Controllers

| File | Changes |
|------|---------|
| `src/controllers/jobs.controller.ts` | - `deleteJob()` calls `storageService.deleteUploadedVideo()` after prefix deletion |

---

## Part 4 — Shopify Staged Uploads & OAuth Success Page

### Summary

This part (latest 2 commits) changed Shopify image uploads to use the `stagedUploadsCreate` flow, added OAuth success page documentation, and improved e-commerce integration:

1. **Shopify staged uploads** — Changed from passing external S3 URLs directly to Shopify to downloading images server-side, uploading via Shopify's `stagedUploadsCreate` flow, then attaching via `productCreateMedia`
2. **Image presigning** — Server generates presigned URLs for S3 images before passing to Shopify to handle private bucket access
3. **Parallel uploads** — Image uploads to staged targets run in parallel for better performance

### Files Modified

#### Providers

| File | Changes |
|------|---------|
| `src/providers/ecommerce/shopify.provider.ts` | - New `createStagedUploads()` method: calls `stagedUploadsCreate` GraphQL mutation |
|                                                 | - New `uploadToStagedTarget()` method: downloads image, builds multipart form, uploads to Shopify staging |
|                                                 | - Rewrote `uploadImages()`: now uses 3-step flow (stage → download+upload → attach) instead of direct URL passing |

#### Routes

| File | Changes |
|------|---------|
| `src/routes/listings.routes.ts` | - `executePush()` generates presigned URLs for S3 images before passing to `shopifyProvider.uploadImages()` |
|                                   | - Uses `extractS3KeyFromUrl()` and `storageService.getPresignedUrl()` for public URL generation |

---

## Part 5 — Commercial Images for Listings & Shopify Staged Uploads

### Summary

This part (latest 3 commits) improved e-commerce integration by using processed commercial product images instead of raw video frames for listings, and implemented Shopify's staged upload flow for more reliable image handling with private S3 buckets:

1. **Commercial images priority** — Listing push now prefers `commercialImages` (AI-processed with backgrounds, lifestyle shots, etc.) from `final/` S3 prefix over `finalFrames` (raw video frames). Falls back to raw frames only if no commercial images exist.
2. **Shopify staged uploads** — Image upload changed from passing external S3 URLs directly to Shopify to using a 3-step `stagedUploadsCreate` flow: download via presigned URL → upload to Shopify staging → attach via `productCreateMedia`
3. **Test fix** — Added missing `deleteUploadedVideo` mock to pipeline service tests

### Files Modified

#### Routes

| File | Changes |
|------|---------|
| `src/routes/listings.routes.ts` | - `executePush()`: Prefers `commercialImages` over `finalFrames` when both exist |
|                                   | - Generates presigned URLs (1 hour expiry) for private S3 bucket access |
|                                   | - Passes presigned URLs to platform providers for image upload |

#### Providers

| File | Changes |
|------|---------|
| `src/providers/ecommerce/shopify.provider.ts` | - New `createStagedUploads()`: calls `stagedUploadsCreate` GraphQL mutation |
|                                                 | - New `uploadToStagedTarget()`: downloads image, builds multipart form, uploads to Shopify |
|                                                 | - Refactored `uploadImages()`: 3-step flow (stage → download+upload → attach) instead of direct URL passing |

#### Services

| File | Changes |
|------|---------|
| `src/services/pipeline.service.test.ts` | - Added missing `deleteUploadedVideo` mock in storageService mock |

---

## Part 3 — OAuth Hardening, Success Page & Shopify productSet

### Summary

This part (commits ef3c18b through c921ceb) enhanced the platform OAuth flow, hardened security, and upgraded the Shopify integration:

1. **Shopify `productSet` mutation** — Replaced `productCreate`/`productUpdate` with the unified `productSet` GraphQL mutation for richer metadata mapping (price, SKU, barcode, weight, SEO, metafields)
2. **Shopify API version** — Updated from `2024-01` to `2026-01`
3. **Platform availability endpoint** — `GET /api/v1/platforms/available` returns which platforms are configured
4. **OAuth success page** — `GET /api/v1/oauth/success` serves an unauthenticated HTML page after OAuth callback redirect, preventing 401 errors
5. **Default redirect URL changed** — `OAUTH_SUCCESS_REDIRECT_URL` default changed from `/api/v1/connections?success=shopify` to `/api/v1/oauth/success`
6. **`buildSuccessRedirectUrl()` helper** — All platform callbacks (Shopify, Amazon, eBay) use a shared helper for building the post-OAuth redirect URL with platform param and open redirect validation
7. **XSS prevention** — OAuth success page uses whitelist lookup for platform names instead of rendering raw user input
8. **Auth skip paths** — Added `/api/v1/oauth/success` and all platform callback paths (`/api/v1/oauth/*/callback`) to bypass authentication
9. **`OAUTH_ALLOWED_REDIRECT_SCHEMES`** — New env var for controlling allowed custom URL schemes in OAuth successRedirect (prevents open redirects)
10. **`trustProxy: 1`** — Added to Fastify for correct `request.protocol` detection behind reverse proxy
11. **Shopify HMAC verification** — Fixed to use all raw query params (not just Zod-parsed ones) since Shopify may send extra params included in the HMAC calculation
12. **JSON response mode** — Shopify authorize endpoint supports `response_type=json` for mobile clients
13. **`successRedirect` param** — OAuth authorize endpoints accept optional `successRedirect` for mobile deep links

### Files Modified

| File | Changes |
|------|---------|
| `src/providers/ecommerce/shopify.provider.ts` | - Replaced `productCreate`/`productUpdate` with `productSet` mutation |
|                                                 | - Updated API version from `2024-01` to `2026-01` |
|                                                 | - Added `buildProductSetInput()` for richer metadata mapping |
|                                                 | - Added `buildMetafields()` for materials, color, gender, style |
| `src/routes/oauth.routes.ts` | - Added `GET /oauth/success` unauthenticated HTML page |
|                                | - Added `GET /platforms/available` endpoint |
|                                | - Added `buildSuccessRedirectUrl()` shared helper |
|                                | - All callbacks now use `buildSuccessRedirectUrl()` |
|                                | - Shopify HMAC uses raw query params |
|                                | - Added `response_type=json` support for Shopify authorize |
|                                | - Added `successRedirect` query param |
| `src/config/env.ts` | - Added `OAUTH_SUCCESS_REDIRECT_URL` (default: `/api/v1/oauth/success`) |
|                       | - Added `OAUTH_ALLOWED_REDIRECT_SCHEMES` |
| `src/config/index.ts` | - Added `oauthSuccessRedirectUrl` and `oauthAllowedRedirectSchemes` to AppConfig |
| `src/middleware/auth.middleware.ts` | - Added `/api/v1/oauth/success` and callback paths to auth skip |
| `src/app.ts` | - Added `trustProxy: 1` to Fastify options |
| `src/services/state-store.service.ts` | - Added `successRedirect` to `OAuthStateData` |
| `src/types/auth.types.ts` | - Added `successRedirect` to authorize query schemas |
| `src/routes/listings.routes.ts` | - Updated Shopify listing push docs/schema |
| `src/utils/constants.ts` | - Added platform-related constants |

---

## Part 6 — Amazon SP-API Production Integration

### Summary

Replaced the stub Amazon e-commerce provider with a full implementation using the `amazon-sp-api` npm package. The SDK handles AWS Signature v4 signing and LWA token refresh automatically using only LWA credentials (client ID + secret + refresh token). No IAM credentials needed.

1. **`amazon-sp-api` SDK** — All SP-API calls now use the `SellingPartner` class with automatic token refresh and rate limit retry
2. **Product CRUD** — `putListingsItem` (create), `patchListingsItem` (update/images), `deleteListingsItem` (delete) with full attribute mapping
3. **Image URLs as attributes** — Amazon images are publicly accessible URLs set in listing attributes (`main_offer_image_locator` + `other_offer_image_locator_1..8`)
4. **Seller info retrieval** — `getSellerInfoFromSPAPI()` retrieves real seller ID and marketplace IDs during OAuth callback (replaces hardcoded `'pending'`)
5. **Refresh token plumbing** — Encrypted refresh tokens decrypted and passed through to Amazon provider from `listings.routes.ts` and `oauth.routes.ts`
6. **EcommerceProvider interface** — Widened `options` parameter to `Record<string, unknown>` on all methods for platform-specific options
7. **Token verification** — `amazonOAuthService.verifyToken()` uses SP-API when refresh token is available, falls back to LWA profile check

### Files Modified

| File | Changes |
|------|---------|
| `package.json` | - Added `amazon-sp-api@^1.2.0` dependency; added `pnpm.patchedDependencies` for TS fix |
| `patches/amazon-sp-api@1.2.0.patch` | - Exports 4 unused interfaces in `catalogItems.ts` to fix `noUnusedLocals` TS errors |
| `src/providers/ecommerce/amazon.provider.ts` | - Full rewrite with `amazon-sp-api` SDK: `createSPClient()`, `createProduct()`, `updateProduct()`, `uploadImages()`, `deleteProduct()`, `verifyToken()`, `getSellerInfoFromSPAPI()` |
| `src/services/oauth/amazon-oauth.service.ts` | - `getSellerInfo()` delegates to `getSellerInfoFromSPAPI()`; `verifyToken()` accepts optional `refreshToken` for SP-API verification |
| `src/types/auth.types.ts` | - `EcommerceProvider` interface: all methods accept `options?: Record<string, unknown>` |
| `src/routes/listings.routes.ts` | - `executePush()` decrypts and passes `refreshToken`, `region`, `marketplaceId` to Amazon provider calls |
| `src/routes/oauth.routes.ts` | - Connection test decrypts and passes `refreshToken` to `amazonOAuthService.verifyToken()` |
