# Edit History - 2025-01-20

## Summary

1. Added a comprehensive CLI testing system for manually testing each pipeline step
2. Implemented secure download URLs endpoint for private S3 bucket access
3. Created shared S3 URL utility to eliminate code duplication
4. Added `extracting_product` status to OpenAPI schema for consistency
5. Improved code quality with parallel async operations and better architecture

## Changes

### New CLI Testing System

Created `src/cli/test/` directory with the following files:

| File | Purpose |
|------|---------|
| `index.ts` | Main menu entry point with ASCII banner and pipeline diagram |
| `utils.ts` | Shared utilities for printing, formatting, and file operations |
| `test-download.ts` | Test video download from HTTP/S3 URLs |
| `test-extract.ts` | Test frame extraction with FFmpeg |
| `test-score.ts` | Test frame scoring algorithm (sharpness + motion) |
| `test-classify.ts` | Test Gemini AI classification |
| `test-generate.ts` | Test Photoroom commercial image generation |
| `test-upload.ts` | Test S3/MinIO upload operations |

### Features

- **Interactive menu**: Arrow-key navigation using `@inquirer/prompts`
- **Styled output**: Colored terminal output using `chalk`
- **Real service testing**: Tests use actual services (storage, video, Gemini, Photoroom)
- **User prompts**: Each test prompts for required inputs (file paths, URLs, options)
- **Progress tracking**: Visual progress indicators and timing information
- **Error handling**: Graceful error handling with informative messages

### Package Updates

- Added dependencies: `@inquirer/prompts`, `chalk`
- Added script: `pnpm test:cli` to run the CLI testing tool

### Code Quality Improvements

After initial creation, performed code review and fixed:
- Division by zero guards in statistics calculations
- URL parsing vulnerability protection
- Extracted shared utilities to reduce code duplication
- Replaced magic numbers with named constants
- Standardized console output through utility functions

## Files Modified

- `package.json` - Added dependencies and `test:cli` script
- `src/cli/test/index.ts` - Created
- `src/cli/test/utils.ts` - Created
- `src/cli/test/test-download.ts` - Created
- `src/cli/test/test-extract.ts` - Created
- `src/cli/test/test-score.ts` - Created
- `src/cli/test/test-classify.ts` - Created
- `src/cli/test/test-generate.ts` - Created
- `src/cli/test/test-upload.ts` - Created

## Usage

```bash
# Run the CLI testing tool
pnpm test:cli

# The menu provides options:
# 1. Download - Download video from URL (HTTP/S3)
# 2. Extract - Extract frames from video (FFmpeg)
# 3. Score - Score frames (sharpness/motion)
# 4. Classify - Classify frames with Gemini AI
# 5. Generate - Generate commercial images (Photoroom)
# 6. Upload - Upload to S3/MinIO
# 7. S3 Operations (list, download, delete, etc.)
# 8. Photoroom Single Operation
```

---

### Presigned Download URLs Endpoint

Added `GET /api/v1/jobs/:id/download-urls` endpoint for secure, time-limited access to job assets.

**File:** `src/routes/jobs.routes.ts`

**Purpose:**
- MinIO bucket is now private (no public access)
- Clients need presigned URLs to download frames and commercial images
- URLs are time-limited (configurable, default 1 hour)

**Features:**
- Returns presigned URLs for all frames and commercial images
- Configurable expiration via `expiresIn` query parameter (60-86400 seconds)
- Handles Docker internal URLs (minio:9000 vs localhost:9000)
- Parallel URL generation for performance

**Usage:**
```bash
curl -H "x-api-key: your-key" \
  "http://localhost:3000/api/v1/jobs/{id}/download-urls?expiresIn=3600"
```

**Response:**
```json
{
  "jobId": "uuid",
  "expiresIn": 3600,
  "frames": [
    { "frameId": "frame_00001", "downloadUrl": "https://..." }
  ],
  "commercialImages": {
    "product_1_variant_hero": {
      "transparent": "https://...",
      "solid": "https://...",
      "real": "https://...",
      "creative": "https://..."
    }
  }
}
```

---

### S3 URL Utility Module

Created shared utility to extract S3 keys from various URL formats, eliminating duplicate code.

**New File:** `src/utils/s3-url.ts`

**Exports:**
- `extractS3KeyFromUrl(url, config, options)` - Extract S3 key from URL
- `isUploadedVideoUrl(url, config)` - Check if URL is from uploads prefix

**Supported URL Formats:**
1. S3 protocol: `s3://bucket/key`
2. Path-style HTTP: `http://endpoint/bucket/key` (MinIO)
3. Path-style with any host: `http://any-host/bucket/key` (Docker internal)
4. Virtual-hosted AWS: `https://bucket.s3.region.amazonaws.com/key`

**Options:**
- `allowAnyHost: true` - Match any hostname (for Docker internal URLs)

**Test Coverage:** 22 unit tests in `src/utils/s3-url.test.ts`

---

### OpenAPI Schema Consistency

Added missing `extracting_product` status to OpenAPI schema.

**File:** `src/routes/jobs.routes.ts` (line 100)

**Change:** The job status enum in OpenAPI now includes all 10 statuses:
- `pending`, `downloading`, `extracting`, `scoring`, `classifying`
- `extracting_product` (added)
- `generating`, `completed`, `failed`, `cancelled`

---

### Code Quality Improvements

**Parallel Async Operations:**
- Download URLs endpoint now generates presigned URLs in parallel using `Promise.all`
- Significant performance improvement for jobs with many images

**Removed Obsolete Config:**
- Removed `version: '3.8'` from `docker-compose.yml` (obsolete in modern Docker Compose)

**Code Formatting:**
- Split long status enum line in `src/types/job.types.ts` for readability

---

## Files Modified (Session 2)

| File | Change Type | Description |
|------|-------------|-------------|
| `src/routes/jobs.routes.ts` | Modified | Added download-urls endpoint, extracting_product status |
| `src/utils/s3-url.ts` | **Created** | Shared S3 URL extraction utility |
| `src/utils/s3-url.test.ts` | **Created** | 22 unit tests for S3 URL utility |
| `src/services/pipeline.service.ts` | Modified | Uses shared S3 URL utility |
| `src/types/job.types.ts` | Modified | Formatted long line |
| `docker-compose.yml` | Modified | Removed obsolete version attribute |

---

## Test Results

All 323 tests pass:
- Frame scoring service: 15 tests
- Gemini service: 27 tests
- Video service: 23 tests
- Storage service: 27 tests
- Pipeline service: 119 tests
- S3 URL utility: 22 tests (new)
- Other tests: 90 tests
