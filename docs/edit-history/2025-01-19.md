# Edit History - 2025-01-19

## Summary

**Session 1**: Created comprehensive documentation for the VOPI project. Established the `/docs` folder structure and generated complete documentation covering architecture, API reference, services, database schema, and deployment guide.

**Session 2**: Updated documentation to reflect significant codebase improvements including:
- Extended environment variable configuration system
- Security enhancements (timing-safe auth, SSRF protection, CORS)
- Database connection pooling with retry logic
- Worker callback improvements with timeout and retry
- Queue configuration options
- Refactored pipeline service architecture

**Session 3**: Committed code changes from Session 2. Documented additional improvements including named constants, race condition fix for job cancellation, and type safety improvements.

**Session 4**: Implemented database-backed API key system with usage tracking, presigned URL upload endpoint for mobile apps, automatic video cleanup, and CLI commands for key management.

**Session 5**: Performed comprehensive code review and fixed 3 critical issues:
- Optimized auth middleware to query by key directly (O(1) instead of O(n))
- Added Zod validation to presigned URL endpoint with safe extension extraction
- Fixed CLI process exit handling to properly report errors

**Session 6**: Fixed warning-level issues from code review:
- Batch insert for frames (N+1 → single query)
- Removed redundant API key usage check
- Improved stream cleanup with `pipeline()`
- Added `--quiet` flag to CLI for scripting

## Documentation Created

### docs/README.md
- Project overview and documentation index
- Key concepts explanation (pipeline, frame selection, AI classification)
- Tech stack summary
- Quick links to all documentation files

### docs/architecture.md
- System architecture diagram
- Component breakdown (API, Queue, Worker, Services)
- Processing pipeline visualization
- Data flow documentation
- Directory structure overview
- Scaling considerations

### docs/api.md
- Complete REST API reference
- Authentication documentation
- All endpoints with request/response examples:
  - Health checks (`/health`, `/ready`)
  - Job management (`POST/GET/DELETE /api/v1/jobs`)
  - Results endpoints (`/frames`, `/images`, `/video`)
- Webhook callback documentation
- Error response formats
- Usage examples with curl

### docs/services.md
- Detailed documentation for all service modules:
  - **VideoService**: FFmpeg operations, frame extraction
  - **FrameScoringService**: Quality analysis algorithm
  - **GeminiService**: AI classification integration
  - **PhotoroomService**: Background removal and image generation
  - **StorageService**: S3/MinIO operations
  - **PipelineService**: Orchestration logic
- Method signatures and return types
- Configuration options

### docs/database.md
- Complete schema documentation for all tables:
  - `jobs`: Main job tracking table
  - `videos`: Video metadata
  - `frames`: Extracted frame data
  - `commercial_images`: Generated images
- JSONB schema definitions
- Relations and foreign keys
- Migration commands
- Index recommendations

### docs/deployment.md
- Local development setup guide
- Docker Compose configuration
- Environment variables reference
- Production deployment considerations
- AWS S3 configuration
- Troubleshooting guide

### docs/edit-history/2025-01-19.md
- This file - session documentation

## Files Changed

| File | Action | Description |
|------|--------|-------------|
| `docs/README.md` | Created | Documentation index and overview |
| `docs/architecture.md` | Created | System design documentation |
| `docs/api.md` | Created | REST API reference |
| `docs/services.md` | Created | Service modules documentation |
| `docs/database.md` | Created | Database schema documentation |
| `docs/deployment.md` | Created | Deployment and setup guide |
| `docs/edit-history/2025-01-19.md` | Created | Session edit history |
| `CLAUDE.md` | Updated | Changed npm to pnpm, added docs links |

## Notes

- Documentation is based on analysis of current codebase state
- All code examples and schemas reflect actual implementation
- Swagger UI remains available at `/docs` for interactive API exploration
- CLAUDE.md updated to use pnpm (matching package.json) and link to new docs

---

## Session 2 - Code Changes Documented

### New Files

| File | Description |
|------|-------------|
| `src/utils/url-validator.ts` | SSRF protection utilities for callback URL validation |
| `src/templates/gemini-system-prompt.ts` | Extracted Gemini system prompt |
| `src/templates/gemini-output-schema.ts` | Extracted Gemini output schema |

### Modified Files

| File | Changes |
|------|---------|
| `.env.example` | Added 30+ new environment variables for configuration |
| `src/config/env.ts` | Extended Zod schema with database pool, queue, callback, CORS, FFmpeg settings |
| `src/config/index.ts` | New AppConfig interface with all configuration categories |
| `src/middleware/auth.middleware.ts` | Added timing-safe comparison, configurable skip paths |
| `src/db/index.ts` | Database connection retry logic with exponential backoff |
| `src/workers/pipeline.worker.ts` | Callback retry with timeout and exponential backoff |
| `src/services/pipeline.service.ts` | Refactored with PipelineContext, WorkDirs, modular steps |
| `src/services/gemini.service.ts` | Configurable model, retry logic from config |
| `src/services/photoroom.service.ts` | Configurable hosts, rate limiting from config |
| `src/services/video.service.ts` | FFmpeg paths from config |
| `src/services/storage.service.ts` | Improved error handling for downloads |
| `src/queues/pipeline.queue.ts` | Configurable retry and retention settings |

### Documentation Updates

| File | Changes |
|------|---------|
| `docs/deployment.md` | Added 40+ new environment variables in organized sections |
| `docs/services.md` | Added URL validator docs, updated service configs |
| `docs/architecture.md` | Added security features, queue config details |
| `CLAUDE.md` | Added security section, configuration overview, new directories |
| `docs/edit-history/2025-01-19.md` | Added Session 2 documentation |

### Key Improvements Documented

1. **Security Hardening**
   - Timing-safe API key comparison prevents timing attacks
   - SSRF protection for callback URLs (domain whitelist, private IP blocking)
   - Configurable CORS domain whitelist
   - Configurable authentication skip paths

2. **Reliability Improvements**
   - Database connection retry with exponential backoff
   - Callback webhook retry with timeout
   - API call rate limiting and retry logic
   - Queue job retention policies

3. **Configuration Flexibility**
   - All hardcoded values moved to environment variables
   - Sensible defaults for all optional settings
   - Organized into logical categories (database, queue, worker, security)

4. **Code Organization**
   - Pipeline service refactored with context pattern
   - Gemini prompts extracted to templates
   - URL validation utilities centralized

---

## Session 3 - Code Changes Committed

The code changes documented in Session 2 were committed in `287f7ed`:

```
refactor: improve code quality, security, and configurability
```

### Additional Changes Not Previously Documented

1. **Named Constants** - Magic numbers replaced with documented constants:
   - `SCORING_CONSTANTS` in `frame-scoring.service.ts` (motion comparison size, thresholds)
   - `PHOTOROOM_CONSTANTS` in `photoroom.service.ts` (retry counts, rate limits)
   - `DB_CONSTANTS` in `db/index.ts` (retry attempts, delays)

2. **Race Condition Fix** - `cancelJob` now uses atomic update with status check:
   ```typescript
   // Only cancel if status is 'pending' - prevents race conditions
   .where(and(eq(schema.jobs.id, jobId), eq(schema.jobs.status, 'pending')))
   ```

3. **Type Safety Improvements**:
   - `JobProgress` type properly used in controller
   - Config validation with `satisfies` operator
   - Proper type casting for JSONB columns

4. **Code Quality**:
   - Replaced `console.error` with `process.stderr.write` for pre-logger errors
   - Removed unused imports and variables
   - Consistent error handling patterns

### Commit Details

| Files Changed | Insertions | Deletions |
|--------------|------------|-----------|
| 19 files | +1,267 | -503 |

All documentation was updated before the commit, so the `/docs` folder accurately reflects the current implementation.

---

## Session 4 - API Key System Implementation

### New Features

1. **Database-backed API Key System**
   - `api_keys` table with usage tracking and limits
   - Each key has `max_uses` and `used_count` for job quotas
   - Optional `expires_at` for time-based expiration
   - Soft delete via `revoked_at`
   - Atomic usage increment to prevent race conditions

2. **Presigned URL Upload Endpoint**
   - `POST /api/v1/uploads/presign` returns presigned S3 URL
   - Mobile apps can upload videos directly to S3
   - Supports video/mp4, video/quicktime, video/webm

3. **Automatic Video Cleanup**
   - Uploaded videos (in `uploads/` prefix) are deleted after job completion
   - Cleanup happens in finally block (success or failure)

4. **CLI Commands for Key Management**
   - `pnpm keys create` - Create new API key
   - `pnpm keys list` - List active keys
   - `pnpm keys revoke <id>` - Revoke a key
   - `pnpm keys info <id>` - Get key details

### Files Created

| File | Description |
|------|-------------|
| `src/cli/api-keys.ts` | CLI for API key management |

### Files Modified

| File | Changes |
|------|---------|
| `src/db/schema.ts` | Added `api_keys` table, `apiKeyId` FK on jobs |
| `src/middleware/auth.middleware.ts` | Database-based key validation, fallback to config |
| `src/controllers/jobs.controller.ts` | Usage limit check, atomic increment |
| `src/routes/jobs.routes.ts` | Added presigned URL endpoint |
| `src/services/storage.service.ts` | Added `getPresignedUploadUrl` method |
| `src/services/pipeline.service.ts` | Added video cleanup after job completion |
| `src/app.ts` | Async auth middleware hook |
| `package.json` | Added `keys`, `keys:create`, `keys:list` scripts |

### Documentation Updates

| File | Changes |
|------|---------|
| `docs/api.md` | Added API key sources, presigned URL endpoint, CLI commands |
| `docs/database.md` | Added api_keys table, apiKeyId on jobs |
| `docs/edit-history/2025-01-19.md` | Added Session 4 documentation |

### API Changes

- New endpoint: `POST /api/v1/uploads/presign`
- Job creation now checks API key usage limits (403 USAGE_LIMIT_EXCEEDED)
- Jobs table now tracks which API key created them

---

## Session 5 - Code Review & Critical Fixes

### Code Review Performed

A comprehensive code review was conducted covering:
- Best practices and security
- Modularity and scalability
- Type safety and performance
- Test coverage analysis

### Critical Issues Fixed

1. **Auth Middleware Query Optimization** (`src/middleware/auth.middleware.ts`)
   - **Issue**: Loaded ALL valid API keys from database on every request, then iterated through them
   - **Fix**: Changed to direct query by key using `eq(schema.apiKeys.key, apiKeyHeader)` with `.limit(1)`
   - **Impact**: O(n) → O(1) database queries per authenticated request

2. **Presigned URL Endpoint Validation** (`src/routes/jobs.routes.ts`)
   - **Issue**: Request body was type-cast without validation, filename extension extraction was vulnerable
   - **Fix**: Added Zod schema validation (`presignBodySchema`) and safe `path.extname()` extraction
   - **Impact**: Prevents malformed input and path traversal attacks

3. **CLI Process Exit Handling** (`src/cli/api-keys.ts`)
   - **Issue**: `process.exit(0)` in `finally` block masked async errors
   - **Fix**: Moved exit handling to proper `.then()/.catch()` chain
   - **Impact**: Proper error codes on CLI failures

### Files Modified

| File | Changes |
|------|---------|
| `src/middleware/auth.middleware.ts` | Direct key query, improved comment on timing-safe comparison |
| `src/middleware/auth.middleware.test.ts` | Updated mocks to match new query structure |
| `src/routes/jobs.routes.ts` | Added `presignBodySchema`, `path` import, safe extension extraction |
| `src/cli/api-keys.ts` | Removed try/finally, added proper `.then()/.catch()` chain |

### New Schema Added

```typescript
const presignBodySchema = z.object({
  filename: z.string().max(255).optional(),
  contentType: z.enum(['video/mp4', 'video/quicktime', 'video/webm']).default('video/mp4'),
  expiresIn: z.number().int().min(60).max(86400).optional(), // 1 minute to 24 hours
});
```

### Verification

- All 180 tests passing
- TypeScript type check passes
- ESLint passes (0 errors, only pre-existing warnings)

---

## Session 6 - Performance & Code Quality Fixes

### Warning Issues Fixed

Addressed warning-level issues identified in the Session 5 code review.

1. **N+1 Query Pattern in Pipeline** (`src/services/pipeline.service.ts`)
   - **Issue**: `saveFrameRecords` inserted frames one-by-one in a loop
   - **Fix**: Batch insert all frames with single `values(frameValues)` call
   - **Bonus**: Used `Set` and `Map` for O(1) candidate/recommended lookups instead of `.find()` and `.some()`

2. **Redundant Usage Check** (`src/controllers/jobs.controller.ts`)
   - **Issue**: Initial `usedCount >= maxUses` check was redundant since atomic update handles it
   - **Fix**: Removed redundant check, kept only atomic update with `lt()` condition in WHERE clause

3. **Stream Cleanup Issues** (`src/services/storage.service.ts`)
   - **Issue**: Manual stream handling with potential cleanup edge cases
   - **Fix**: Replaced with `Readable.fromWeb()` + `pipeline()` which automatically handles cleanup, errors, and backpressure

4. **API Key Displayed in Console** (`src/cli/api-keys.ts`)
   - **Issue**: Full API key printed to console, could be logged
   - **Fix**: Added `--quiet` flag that outputs only the key value (useful for scripting, reduces log exposure)

### Files Modified

| File | Changes |
|------|---------|
| `src/services/pipeline.service.ts` | Batch insert, Set/Map for lookups |
| `src/controllers/jobs.controller.ts` | Removed redundant check |
| `src/services/storage.service.ts` | `Readable.fromWeb()` + `pipeline()` |
| `src/cli/api-keys.ts` | Added `--quiet` flag |

### Code Examples

**Batch Insert (Before → After)**:
```typescript
// Before: N+1 queries
for (const frame of scoredFrames) {
  const [record] = await db.insert(schema.frames).values({...}).returning();
}

// After: Single batch insert
const records = await db.insert(schema.frames).values(frameValues).returning();
```

**Stream Handling (Before → After)**:
```typescript
// Before: Manual handling
const reader = response.body?.getReader();
while (true) {
  const { done, value } = await reader.read();
  if (done) break;
  writeStream.write(value);
}

// After: Automatic cleanup
const nodeStream = Readable.fromWeb(response.body);
await pipeline(nodeStream, writeStream);
```

### CLI Usage

```bash
# Normal output (verbose)
pnpm keys create --name "My App"

# Quiet mode (key only, for scripting)
API_KEY=$(pnpm keys create --name "My App" --quiet)
```

### Verification

- All 180 tests passing
- TypeScript type check passes
- ESLint passes (0 errors)
