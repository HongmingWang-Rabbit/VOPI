# Edit History - January 23, 2026

## Session Summary

This session focused on implementing code review suggestions and improving the processor architecture with centralized concurrency configuration and comprehensive test coverage.

### Major Changes

1. **Centralized Concurrency Configuration** - New `concurrency.ts` module with documented defaults for all processor types
2. **New Test Files** - Added comprehensive tests for 3 processors that were missing test coverage
3. **Code Review Fixes** - Fixed type errors and improved type safety across several files

---

## Files Created

### Processor Infrastructure

| File | Description |
|------|-------------|
| `src/processors/concurrency.ts` | Centralized concurrency defaults with documentation |
| `src/processors/concurrency.test.ts` | 10 tests for concurrency module |

### Processor Tests

| File | Tests | Description |
|------|-------|-------------|
| `src/processors/impl/claid/claid-bg-remove.test.ts` | 11 | Claid background removal processor tests |
| `src/processors/impl/sharp/center-product.test.ts` | 11 | Center product processor tests |
| `src/processors/impl/photoroom/generate-commercial.test.ts` | 10 | Commercial image generation tests |

---

## Files Modified

### Processor Implementations

| File | Changes |
|------|---------|
| `src/processors/impl/claid/claid-bg-remove.ts` | Use centralized `getConcurrency('CLAID_BG_REMOVE', options)` |
| `src/processors/impl/sharp/fill-product-holes.ts` | Use centralized `getConcurrency('STABILITY_INPAINT', options)` |
| `src/processors/impl/sharp/center-product.ts` | Use centralized `getConcurrency('SHARP_TRANSFORM', options)` |
| `src/processors/impl/photoroom/generate-commercial.ts` | Use centralized `getConcurrency('PHOTOROOM_GENERATE', options)` |

### Services

| File | Changes |
|------|---------|
| `src/services/video.service.ts` | Import and use `PROCESSOR_CONCURRENCY.FFMPEG_EXTRACT` |

### Providers

| File | Changes |
|------|---------|
| `src/providers/implementations/gemini-audio-analysis.provider.ts` | Added `nullToUndefined()` helper to fix Zod null/undefined mismatch |

---

## Centralized Concurrency Configuration

### Module: `src/processors/concurrency.ts`

The new concurrency module provides:
- **Single source of truth** for all processor concurrency defaults
- **Documented rationale** for each value
- **Type-safe `getConcurrency()` helper** with override validation

### Default Values

| Constant | Value | Rationale |
|----------|-------|-----------|
| `CLAID_BG_REMOVE` | 5 | External API, 2-5s per request |
| `STABILITY_INPAINT` | 3 | External API, 3-8s per request, lower to avoid rate limiting |
| `SHARP_TRANSFORM` | 8 | CPU-bound local processing, ~50-200ms per image |
| `PHOTOROOM_GENERATE` | 3 | External API, 2-4s per request |
| `FFMPEG_EXTRACT` | 4 | I/O bound, balanced for disk throughput |

### Usage

```typescript
import { getConcurrency, PROCESSOR_CONCURRENCY } from '../../concurrency.js';

// In processor execute function:
const concurrency = getConcurrency('CLAID_BG_REMOVE', options);

// In service (direct access):
const concurrency = PROCESSOR_CONCURRENCY.FFMPEG_EXTRACT;
```

### Override via Options

```typescript
// User can override via processor options:
await processor.execute(context, data, { concurrency: 10 });
```

The `getConcurrency()` function validates overrides:
- Must be a positive number
- Decimals are floored
- Invalid values fall back to default

---

## New Test Coverage

### Test Files Added

| File | Tests | Coverage |
|------|-------|----------|
| `concurrency.test.ts` | 10 | Constants validation, getConcurrency validation |
| `claid-bg-remove.test.ts` | 11 | Processor metadata, execute behavior, error handling |
| `center-product.test.ts` | 11 | Centering logic, content bounds, failures |
| `generate-commercial.test.ts` | 10 | Generation flow, versions, partial failures |

**Total**: 42 new tests

### Test Patterns Used

All new test files follow the established pattern:
1. Mock logger before imports
2. Mock external dependencies (providers, services, database)
3. Create mock context with `PipelineTimer`
4. Test processor metadata (id, displayName, io)
5. Test execute with various inputs
6. Test error handling and edge cases
7. Test progress reporting

---

## Bug Fixes

### Type Error: Zod null vs undefined

**File**: `src/providers/implementations/gemini-audio-analysis.provider.ts`

**Issue**: Zod's `.nullish()` returns `T | null | undefined` but `ProductMetadata` expects `T | undefined`

**Fix**: Added `nullToUndefined()` helper method:
```typescript
private nullToUndefined<T>(value: T | null | undefined): T | undefined {
  return value ?? undefined;
}
```

### Test Mock Shape Mismatch

**File**: `src/processors/impl/photoroom/generate-commercial.test.ts`

**Issue**: Mock returns had `success` field that doesn't exist in `AllVersionsResult` interface

**Fix**: Updated mock returns to match correct interface:
```typescript
// Before (wrong):
mockResolvedValue({ success: true, ... })

// After (correct):
mockResolvedValue({ frameId: 'frame_001', recommendedType: 'front', versions: {...} })
```

---

## Test Results

```
All 821+ tests passing
- Processor tests: 213 passing
- Concurrency tests: 10 passing
- New processor tests: 32 passing
```

---

## Architecture Impact

### Before: Hardcoded Concurrency

Each processor had its own hardcoded concurrency value with no documentation:
```typescript
// In claid-bg-remove.ts
const concurrency = options?.concurrency ?? 5;

// In fill-product-holes.ts
const concurrency = options?.concurrency ?? 3;
```

### After: Centralized & Documented

Single source of truth with clear rationale:
```typescript
// src/processors/concurrency.ts
export const PROCESSOR_CONCURRENCY = {
  /**
   * Claid.ai background removal API
   * - External API with rate limits
   * - Each request takes 2-5 seconds
   */
  CLAID_BG_REMOVE: 5,
  // ...
} as const;
```

This improves:
- **Maintainability**: Change defaults in one place
- **Documentation**: Clear rationale for each value
- **Type Safety**: `ProcessorConcurrencyKey` type ensures valid keys
- **Testability**: Easier to test concurrency behavior
