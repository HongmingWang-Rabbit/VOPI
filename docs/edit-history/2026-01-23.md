# Edit History - January 23, 2026

## Session Summary

This session focused on **performance optimization** and **code quality improvements** across the processor architecture.

### Major Changes

1. **Parallel Processing Optimization** - Gemini classification batches and S3 uploads now run in parallel
2. **Environment Variable Concurrency Overrides** - All concurrency settings now configurable via `VOPI_CONCURRENCY_*` env vars
3. **S3 Connection Keep-Alive** - Added HTTP agent with connection reuse for faster uploads
4. **Code Consolidation** - All processors now use unified `getInputFrames()` utility (8 total)
5. **New Concurrency Keys** - Added `GEMINI_CLASSIFY` (2) and `S3_UPLOAD` (6) to centralized config
6. **Increased Stability Inpaint** - Changed from 3 â†’ 4 to process all frames in one round

### Performance Improvements

| Optimization | Before | After | Impact |
|-------------|--------|-------|--------|
| Gemini batch processing | Sequential | Parallel (concurrency: 2) | ~50% faster with multiple batches |
| S3 uploads | Sequential | Parallel (concurrency: 6) | ~6x faster for multiple frames |
| S3 connections | New connection per request | Keep-alive with 25 max sockets | Reduced latency variance |
| Stability inpaint | Concurrency 3 | Concurrency 4 | 4 frames in 1 round vs 2 rounds |
| DB updates (upload-frames) | Sequential | Parallel via Promise.all | Faster for many frames |

---

## Files Created

### Processor Infrastructure

| File | Description |
|------|-------------|
| `src/processors/concurrency.ts` | Centralized concurrency defaults with documentation |
| `src/processors/concurrency.test.ts` | 10 tests for concurrency module |

### Processor Tests

| File | Tests | Description |
|------|-------|-------------|
| `src/processors/impl/claid/claid-bg-remove.test.ts` | 11 | Claid background removal processor tests |
| `src/processors/impl/sharp/center-product.test.ts` | 11 | Center product processor tests |
| `src/processors/impl/photoroom/generate-commercial.test.ts` | 10 | Commercial image generation tests |

---

## Files Modified

### Processor Implementations

| File | Changes |
|------|---------|
| `src/processors/impl/claid/claid-bg-remove.ts` | Use centralized `getConcurrency('CLAID_BG_REMOVE', options)` |
| `src/processors/impl/sharp/fill-product-holes.ts` | Use centralized `getConcurrency('STABILITY_INPAINT', options)` |
| `src/processors/impl/sharp/center-product.ts` | Use centralized `getConcurrency('SHARP_TRANSFORM', options)` |
| `src/processors/impl/photoroom/generate-commercial.ts` | Use centralized `getConcurrency('PHOTOROOM_GENERATE', options)` |

### Services

| File | Changes |
|------|---------|
| `src/services/video.service.ts` | Import and use `PROCESSOR_CONCURRENCY.FFMPEG_EXTRACT` |

### Providers

| File | Changes |
|------|---------|
| `src/providers/implementations/gemini-audio-analysis.provider.ts` | Added `nullToUndefined()` helper to fix Zod null/undefined mismatch |

---

## Centralized Concurrency Configuration

### Module: `src/processors/concurrency.ts`

The new concurrency module provides:
- **Single source of truth** for all processor concurrency defaults
- **Documented rationale** for each value
- **Type-safe `getConcurrency()` helper** with override validation

### Default Values

| Constant | Value | Rationale |
|----------|-------|-----------|
| `CLAID_BG_REMOVE` | 5 | External API, 2-5s per request |
| `STABILITY_INPAINT` | 4 | External API, 3-8s per request |
| `SHARP_TRANSFORM` | 8 | CPU-bound local processing, ~50-200ms per image |
| `PHOTOROOM_GENERATE` | 3 | External API, 2-4s per request |
| `FFMPEG_EXTRACT` | 4 | I/O bound, balanced for disk throughput |
| `GEMINI_CLASSIFY` | 2 | External API, 30-180s per batch, low to avoid quota exhaustion |
| `S3_UPLOAD` | 6 | Network I/O, connection reuse via keep-alive |

### Usage

```typescript
import { getConcurrency, PROCESSOR_CONCURRENCY } from '../../concurrency.js';

// In processor execute function:
const concurrency = getConcurrency('CLAID_BG_REMOVE', options);

// In service (direct access):
const concurrency = PROCESSOR_CONCURRENCY.FFMPEG_EXTRACT;
```

### Override via Options

```typescript
// User can override via processor options:
await processor.execute(context, data, { concurrency: 10 });
```

The `getConcurrency()` function validates overrides:
- Must be a positive number
- Decimals are floored
- Capped at `MAX_CONCURRENCY` (50)
- Invalid values fall back to default

### Environment Variable Overrides

All concurrency values can be overridden via environment variables:

```bash
# Example: Increase Gemini classification parallelism
VOPI_CONCURRENCY_GEMINI_CLASSIFY=4

# Example: Increase S3 upload parallelism
VOPI_CONCURRENCY_S3_UPLOAD=10
```

Available env vars:
- `VOPI_CONCURRENCY_CLAID_BG_REMOVE`
- `VOPI_CONCURRENCY_STABILITY_INPAINT`
- `VOPI_CONCURRENCY_SHARP_TRANSFORM`
- `VOPI_CONCURRENCY_PHOTOROOM_GENERATE`
- `VOPI_CONCURRENCY_FFMPEG_EXTRACT`
- `VOPI_CONCURRENCY_GEMINI_CLASSIFY`
- `VOPI_CONCURRENCY_S3_UPLOAD`

---

## New Test Coverage

### Test Files Added

| File | Tests | Coverage |
|------|-------|----------|
| `concurrency.test.ts` | 10 | Constants validation, getConcurrency validation |
| `claid-bg-remove.test.ts` | 11 | Processor metadata, execute behavior, error handling |
| `center-product.test.ts` | 11 | Centering logic, content bounds, failures |
| `generate-commercial.test.ts` | 10 | Generation flow, versions, partial failures |

**Total**: 42 new tests

### Test Patterns Used

All new test files follow the established pattern:
1. Mock logger before imports
2. Mock external dependencies (providers, services, database)
3. Create mock context with `PipelineTimer`
4. Test processor metadata (id, displayName, io)
5. Test execute with various inputs
6. Test error handling and edge cases
7. Test progress reporting

---

## Bug Fixes

### Type Error: Zod null vs undefined

**File**: `src/providers/implementations/gemini-audio-analysis.provider.ts`

**Issue**: Zod's `.nullish()` returns `T | null | undefined` but `ProductMetadata` expects `T | undefined`

**Fix**: Added `nullToUndefined()` helper method:
```typescript
private nullToUndefined<T>(value: T | null | undefined): T | undefined {
  return value ?? undefined;
}
```

### Test Mock Shape Mismatch

**File**: `src/processors/impl/photoroom/generate-commercial.test.ts`

**Issue**: Mock returns had `success` field that doesn't exist in `AllVersionsResult` interface

**Fix**: Updated mock returns to match correct interface:
```typescript
// Before (wrong):
mockResolvedValue({ success: true, ... })

// After (correct):
mockResolvedValue({ frameId: 'frame_001', recommendedType: 'front', versions: {...} })
```

---

## Test Results

```
All 876 tests passing
- Processor tests: 277 passing
- Concurrency tests: 20 passing (including 7 new env var tests)
- Types tests: 32 passing (including 9 getInputFrames tests)
```

---

## Architecture Impact

### Before: Hardcoded Concurrency

Each processor had its own hardcoded concurrency value with no documentation:
```typescript
// In claid-bg-remove.ts
const concurrency = options?.concurrency ?? 5;

// In fill-product-holes.ts
const concurrency = options?.concurrency ?? 3;
```

### After: Centralized & Documented

Single source of truth with clear rationale:
```typescript
// src/processors/concurrency.ts
export const PROCESSOR_CONCURRENCY = {
  /**
   * Claid.ai background removal API
   * - External API with rate limits
   * - Each request takes 2-5 seconds
   */
  CLAID_BG_REMOVE: 5,
  // ...
} as const;
```

This improves:
- **Maintainability**: Change defaults in one place
- **Documentation**: Clear rationale for each value
- **Type Safety**: `ProcessorConcurrencyKey` type ensures valid keys
- **Testability**: Easier to test concurrency behavior
- **Runtime Configuration**: Override via environment variables

---

## Session 2: Performance Optimizations

### Files Modified

| File | Changes |
|------|---------|
| `src/processors/concurrency.ts` | Added env var support, new GEMINI_CLASSIFY and S3_UPLOAD keys, increased STABILITY_INPAINT to 4 |
| `src/processors/concurrency.test.ts` | Added 7 tests for env var parsing |
| `src/processors/impl/gemini/gemini-classify.ts` | Parallel batch processing, use `getInputFrames()`, moved BatchResult to module level |
| `src/processors/impl/storage/upload-frames.ts` | Parallel S3 uploads, parallel DB updates via Promise.all |
| `src/services/storage.service.ts` | Added HTTP_AGENT_CONFIG constant, keep-alive agents for connection reuse |
| `src/processors/impl/sharp/rotate-image.ts` | Use `getInputFrames()` utility |
| `src/processors/impl/sharp/score-frames.ts` | Use `getInputFrames()` utility |

### S3 Keep-Alive Configuration

New `HTTP_AGENT_CONFIG` constant in `storage.service.ts`:

```typescript
const HTTP_AGENT_CONFIG = {
  keepAlive: true,
  maxSockets: 25,        // Match concurrency settings
  keepAliveMsecs: 3000,  // Keep-alive probe interval
  connectionTimeout: 5000,
  socketTimeout: 30000,
} as const;
```

### Processors Using `getInputFrames()`

All 8 processors now use the unified utility:

1. `claid-bg-remove.ts`
2. `center-product.ts`
3. `fill-product-holes.ts`
4. `generate-commercial.ts`
5. `rotate-image.ts`
6. `score-frames.ts`
7. `upload-frames.ts`
8. `gemini-classify.ts`
