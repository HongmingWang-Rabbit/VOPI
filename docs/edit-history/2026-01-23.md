# Edit History - January 23, 2026

## Session Summary

This session focused on **performance optimization** and **code quality improvements** across the processor architecture.

### Major Changes

1. **Parallel Processing Optimization** - Gemini classification batches and S3 uploads now run in parallel
2. **Environment Variable Concurrency Overrides** - All concurrency settings now configurable via `VOPI_CONCURRENCY_*` env vars
3. **S3 Connection Keep-Alive** - Added HTTP agent with connection reuse for faster uploads
4. **Code Consolidation** - All processors now use unified `getInputFrames()` utility (8 total)
5. **New Concurrency Keys** - Added `GEMINI_CLASSIFY` (2) and `S3_UPLOAD` (6) to centralized config
6. **Increased Stability Inpaint** - Changed from 3 → 4 to process all frames in one round

### Performance Improvements

| Optimization | Before | After | Impact |
|-------------|--------|-------|--------|
| Gemini batch processing | Sequential | Parallel (concurrency: 2) | ~50% faster with multiple batches |
| S3 uploads | Sequential | Parallel (concurrency: 6) | ~6x faster for multiple frames |
| S3 connections | New connection per request | Keep-alive with 25 max sockets | Reduced latency variance |
| Stability inpaint | Concurrency 3 | Concurrency 4 | 4 frames in 1 round vs 2 rounds |
| DB updates (upload-frames) | Sequential | Parallel via Promise.all | Faster for many frames |

---

## Files Created

### Processor Infrastructure

| File | Description |
|------|-------------|
| `src/processors/concurrency.ts` | Centralized concurrency defaults with documentation |
| `src/processors/concurrency.test.ts` | 10 tests for concurrency module |

### Processor Tests

| File | Tests | Description |
|------|-------|-------------|
| `src/processors/impl/claid/claid-bg-remove.test.ts` | 11 | Claid background removal processor tests |
| `src/processors/impl/sharp/center-product.test.ts` | 11 | Center product processor tests |
| `src/processors/impl/photoroom/generate-commercial.test.ts` | 10 | Commercial image generation tests |

---

## Files Modified

### Processor Implementations

| File | Changes |
|------|---------|
| `src/processors/impl/claid/claid-bg-remove.ts` | Use centralized `getConcurrency('CLAID_BG_REMOVE', options)` |
| `src/processors/impl/sharp/fill-product-holes.ts` | Use centralized `getConcurrency('STABILITY_INPAINT', options)` |
| `src/processors/impl/sharp/center-product.ts` | Use centralized `getConcurrency('SHARP_TRANSFORM', options)` |
| `src/processors/impl/photoroom/generate-commercial.ts` | Use centralized `getConcurrency('PHOTOROOM_GENERATE', options)` |

### Services

| File | Changes |
|------|---------|
| `src/services/video.service.ts` | Import and use `PROCESSOR_CONCURRENCY.FFMPEG_EXTRACT` |

### Providers

| File | Changes |
|------|---------|
| `src/providers/implementations/gemini-audio-analysis.provider.ts` | Added `nullToUndefined()` helper to fix Zod null/undefined mismatch |

---

## Centralized Concurrency Configuration

### Module: `src/processors/concurrency.ts`

The new concurrency module provides:
- **Single source of truth** for all processor concurrency defaults
- **Documented rationale** for each value
- **Type-safe `getConcurrency()` helper** with override validation

### Default Values

| Constant | Value | Rationale |
|----------|-------|-----------|
| `CLAID_BG_REMOVE` | 5 | External API, 2-5s per request |
| `STABILITY_INPAINT` | 4 | External API, 3-8s per request |
| `SHARP_TRANSFORM` | 8 | CPU-bound local processing, ~50-200ms per image |
| `PHOTOROOM_GENERATE` | 3 | External API, 2-4s per request |
| `FFMPEG_EXTRACT` | 4 | I/O bound, balanced for disk throughput |
| `GEMINI_CLASSIFY` | 2 | External API, 30-180s per batch, low to avoid quota exhaustion |
| `S3_UPLOAD` | 6 | Network I/O, connection reuse via keep-alive |

### Usage

```typescript
import { getConcurrency, PROCESSOR_CONCURRENCY } from '../../concurrency.js';

// In processor execute function:
const concurrency = getConcurrency('CLAID_BG_REMOVE', options);

// In service (direct access):
const concurrency = PROCESSOR_CONCURRENCY.FFMPEG_EXTRACT;
```

### Override via Options

```typescript
// User can override via processor options:
await processor.execute(context, data, { concurrency: 10 });
```

The `getConcurrency()` function validates overrides:
- Must be a positive number
- Decimals are floored
- Capped at `MAX_CONCURRENCY` (50)
- Invalid values fall back to default

### Environment Variable Overrides

All concurrency values can be overridden via environment variables:

```bash
# Example: Increase Gemini classification parallelism
VOPI_CONCURRENCY_GEMINI_CLASSIFY=4

# Example: Increase S3 upload parallelism
VOPI_CONCURRENCY_S3_UPLOAD=10
```

Available env vars:
- `VOPI_CONCURRENCY_CLAID_BG_REMOVE`
- `VOPI_CONCURRENCY_STABILITY_INPAINT`
- `VOPI_CONCURRENCY_SHARP_TRANSFORM`
- `VOPI_CONCURRENCY_PHOTOROOM_GENERATE`
- `VOPI_CONCURRENCY_FFMPEG_EXTRACT`
- `VOPI_CONCURRENCY_GEMINI_CLASSIFY`
- `VOPI_CONCURRENCY_S3_UPLOAD`

---

## New Test Coverage

### Test Files Added

| File | Tests | Coverage |
|------|-------|----------|
| `concurrency.test.ts` | 10 | Constants validation, getConcurrency validation |
| `claid-bg-remove.test.ts` | 11 | Processor metadata, execute behavior, error handling |
| `center-product.test.ts` | 11 | Centering logic, content bounds, failures |
| `generate-commercial.test.ts` | 10 | Generation flow, versions, partial failures |

**Total**: 42 new tests

### Test Patterns Used

All new test files follow the established pattern:
1. Mock logger before imports
2. Mock external dependencies (providers, services, database)
3. Create mock context with `PipelineTimer`
4. Test processor metadata (id, displayName, io)
5. Test execute with various inputs
6. Test error handling and edge cases
7. Test progress reporting

---

## Bug Fixes

### Type Error: Zod null vs undefined

**File**: `src/providers/implementations/gemini-audio-analysis.provider.ts`

**Issue**: Zod's `.nullish()` returns `T | null | undefined` but `ProductMetadata` expects `T | undefined`

**Fix**: Added `nullToUndefined()` helper method:
```typescript
private nullToUndefined<T>(value: T | null | undefined): T | undefined {
  return value ?? undefined;
}
```

### Test Mock Shape Mismatch

**File**: `src/processors/impl/photoroom/generate-commercial.test.ts`

**Issue**: Mock returns had `success` field that doesn't exist in `AllVersionsResult` interface

**Fix**: Updated mock returns to match correct interface:
```typescript
// Before (wrong):
mockResolvedValue({ success: true, ... })

// After (correct):
mockResolvedValue({ frameId: 'frame_001', recommendedType: 'front', versions: {...} })
```

---

## Test Results

```
All 876 tests passing
- Processor tests: 277 passing
- Concurrency tests: 20 passing (including 7 new env var tests)
- Types tests: 32 passing (including 9 getInputFrames tests)
```

---

## Architecture Impact

### Before: Hardcoded Concurrency

Each processor had its own hardcoded concurrency value with no documentation:
```typescript
// In claid-bg-remove.ts
const concurrency = options?.concurrency ?? 5;

// In fill-product-holes.ts
const concurrency = options?.concurrency ?? 3;
```

### After: Centralized & Documented

Single source of truth with clear rationale:
```typescript
// src/processors/concurrency.ts
export const PROCESSOR_CONCURRENCY = {
  /**
   * Claid.ai background removal API
   * - External API with rate limits
   * - Each request takes 2-5 seconds
   */
  CLAID_BG_REMOVE: 5,
  // ...
} as const;
```

This improves:
- **Maintainability**: Change defaults in one place
- **Documentation**: Clear rationale for each value
- **Type Safety**: `ProcessorConcurrencyKey` type ensures valid keys
- **Testability**: Easier to test concurrency behavior
- **Runtime Configuration**: Override via environment variables

---

## Session 2: Performance Optimizations

### Files Modified

| File | Changes |
|------|---------|
| `src/processors/concurrency.ts` | Added env var support, new GEMINI_CLASSIFY and S3_UPLOAD keys, increased STABILITY_INPAINT to 4 |
| `src/processors/concurrency.test.ts` | Added 7 tests for env var parsing |
| `src/processors/impl/gemini/gemini-classify.ts` | Parallel batch processing, use `getInputFrames()`, moved BatchResult to module level |
| `src/processors/impl/storage/upload-frames.ts` | Parallel S3 uploads, parallel DB updates via Promise.all |
| `src/services/storage.service.ts` | Added HTTP_AGENT_CONFIG constant, keep-alive agents for connection reuse |
| `src/processors/impl/sharp/rotate-image.ts` | Use `getInputFrames()` utility |
| `src/processors/impl/sharp/score-frames.ts` | Use `getInputFrames()` utility |

### S3 Keep-Alive Configuration

New `HTTP_AGENT_CONFIG` constant in `storage.service.ts`:

```typescript
const HTTP_AGENT_CONFIG = {
  keepAlive: true,
  maxSockets: 25,        // Match concurrency settings
  keepAliveMsecs: 3000,  // Keep-alive probe interval
  connectionTimeout: 5000,
  socketTimeout: 30000,
} as const;
```

### Processors Using `getInputFrames()`

All 8 processors now use the unified utility:

1. `claid-bg-remove.ts`
2. `center-product.ts`
3. `fill-product-holes.ts`
4. `generate-commercial.ts`
5. `rotate-image.ts`
6. `score-frames.ts`
7. `upload-frames.ts`
8. `gemini-classify.ts`

---

## Session 3: Minimum Sharpness Threshold

### Problem

Blurry frames were being selected even when the video had fast motion during certain segments. The scoring system picked the "best" frame per second, but if all frames in that second were blurry (e.g., during fast hand movement), a blurry frame would still be selected.

### Solution

Added a minimum sharpness threshold that rejects frames below an absolute quality level before selecting the best frame per second.

### Files Modified

| File | Changes |
|------|---------|
| `src/services/frame-scoring.service.ts` | Added threshold filtering to `selectBestFramePerSecond()`, changed default `minSharpnessThreshold` from 0 → 5 |
| `src/processors/impl/sharp/score-frames.ts` | Accept `minSharpnessThreshold` option, pass config to service |
| `src/services/frame-scoring.service.test.ts` | Updated default value test, added 3 new threshold tests |

### Implementation

```typescript
// In selectBestFramePerSecond():
const usableFrames = scoredFrames.filter((f) => f.sharpness >= minSharpnessThreshold);

// Logging for visibility:
logger.info(
  { rejected: rejectedCount, threshold: minSharpnessThreshold },
  `Rejected ${rejectedCount} blurry frames (sharpness < ${minSharpnessThreshold})`
);
```

### Configuration

```typescript
// Default (rejects frames with sharpness < 5)
DEFAULT_SCORING_CONFIG.minSharpnessThreshold = 5;

// Override via processor options:
{ minSharpnessThreshold: 10 }  // Stricter
{ minSharpnessThreshold: 0 }   // Disabled (old behavior)
```

### New Tests Added

| Test | Description |
|------|-------------|
| `should filter out frames below minimum sharpness threshold` | Verifies frames below threshold are excluded |
| `should use default threshold when no config provided` | Verifies default threshold of 5 is applied |
| `should accept all frames when threshold is 0` | Verifies old behavior when disabled |

---

## Session 4: Code Quality Improvements

### O(n²) → O(n) Optimization

**File**: `src/processors/impl/sharp/score-frames.ts`

**Issue**: Using `inputFrames.find()` inside a `map()` loop creates O(n²) complexity

**Fix**: Build a Map for O(1) lookups:
```typescript
// Before: O(n²)
const original = inputFrames.find((f) => f.frameId === sf.frameId);

// After: O(n)
const inputFrameMap = new Map(inputFrames.map(f => [f.frameId, f]));
const original = inputFrameMap.get(sf.frameId);
```

### Documentation Update

**File**: `src/processors/concurrency.ts`

Added missing `VOPI_CONCURRENCY_STABILITY_BG_REMOVE` to the header documentation.

---

## Session 5: HEVC Transcoding Optimization

### Problem

Video transcoding from HEVC (iPhone videos) to H.264 (for Gemini compatibility) was taking 5+ minutes, causing significant delays in the Gemini Video pipeline.

### Solution

Optimized FFmpeg transcoding settings for speed over quality (acceptable for AI analysis):

| Setting | Before | After | Impact |
|---------|--------|-------|--------|
| Preset | `fast` | `ultrafast` | ~3-5x faster encoding |
| CRF | `23` | `28` | Smaller file, faster |
| Resolution | Original | 720p | Major speedup for 4K/1080p |
| Threads | Default | All cores (`-threads 0`) | Better CPU utilization |
| Audio | Re-encode to AAC | Copy stream (fallback to AAC) | Instant when compatible |

**Expected result**: 5-10x faster transcoding

### Files Modified

| File | Changes |
|------|---------|
| `src/providers/utils/gemini-utils.ts` | Optimized transcoding, added timeout, audio fallback, env var config |
| `src/providers/utils/gemini-utils.test.ts` | Added 14 new tests for transcoding functions |

### New Constants

```typescript
// In src/providers/utils/gemini-utils.ts
export const TRANSCODE_PRESET = 'ultrafast';
export const TRANSCODE_CRF = '28';
export const TRANSCODE_AUDIO_BITRATE = '128k';
export const TRANSCODE_TARGET_HEIGHT = parseIntEnv(process.env.VOPI_TRANSCODE_HEIGHT, 720);
export const TRANSCODE_TIMEOUT_MS = parseIntEnv(process.env.VOPI_TRANSCODE_TIMEOUT_MS, 600_000);
export const FFPROBE_TIMEOUT_MS = parseIntEnv(process.env.VOPI_FFPROBE_TIMEOUT_MS, 30_000);
```

### New Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `VOPI_TRANSCODE_HEIGHT` | `720` | Target video height for transcoding |
| `VOPI_TRANSCODE_TIMEOUT_MS` | `600000` | Timeout for transcoding (10 min) |
| `VOPI_FFPROBE_TIMEOUT_MS` | `30000` | Timeout for codec detection (30 sec) |

### Key Improvements

1. **Audio codec fallback**: Tries `-c:a copy` first (instant), falls back to AAC if incompatible
2. **Timeout protection**: Both ffprobe (30s) and ffmpeg (10min) have configurable timeouts
3. **Safe env var parsing**: Helper function with NaN protection
4. **Unique temp filenames**: Timestamp + random suffix prevents collisions
5. **Comprehensive logging**: Logs settings, fallback events, and cleanup

### New Test Coverage

| Test Suite | Tests | Coverage |
|------------|-------|----------|
| `isHevcCodec` | 6 | HEVC detection, h265, h264, errors, timeout |
| `transcodeToH264` | 4 | Success, AAC fallback, failures, spawn errors |
| `cleanupTranscodedFile` | 3 | Delete, null path, error handling |
| `prepareVideoForGemini` | 2 | Non-HEVC passthrough, HEVC transcode + cleanup |

**Total new tests**: 15 (48 total in gemini-utils.test.ts)

---

## Test Results (Final)

```
All 909 tests passing
- Processor tests: 313 passing
- Frame scoring tests: 22 passing
- Gemini utils tests: 48 passing
```

---

## Session 6: Stability AI Integration & Commercial Image Generation

### Overview

Replaced Photoroom commercial image generation with Stability AI APIs for higher quality results. Added new unified video analyzer that combines audio + video analysis in a single Gemini API call.

### New Files Created

#### Stability AI Providers

| File | Description |
|------|-------------|
| `src/providers/implementations/stability-commercial.provider.ts` | Commercial image generation using Stability Replace Background + Relight API |
| `src/providers/implementations/stability-commercial.provider.test.ts` | 13 tests for commercial provider |
| `src/providers/implementations/stability-upscale.provider.ts` | Image upscaling using conservative/creative upscale APIs |
| `src/providers/implementations/stability-upscale.provider.test.ts` | 12 tests for upscale provider |
| `src/providers/implementations/stability-background-removal.provider.ts` | Background removal using Stability remove-background API |
| `src/providers/implementations/stability-background-removal.provider.test.ts` | 15 tests for bg removal provider |

#### Stability AI Shared Utilities

| File | Description |
|------|-------------|
| `src/providers/utils/stability-api.ts` | Shared API utilities: request handling, retry logic, polling, hex color parsing |
| `src/providers/utils/stability-api.test.ts` | 19 tests for API utilities |

#### Stability AI Processors

| File | Description |
|------|-------------|
| `src/processors/impl/stability/stability-commercial.ts` | Commercial image generation processor (transparent, solid, real, creative versions) |
| `src/processors/impl/stability/stability-upscale.ts` | Image upscaling processor |
| `src/processors/impl/stability/stability-bg-remove.ts` | Background removal processor |

#### Unified Video Analyzer

| File | Description |
|------|-------------|
| `src/providers/implementations/gemini-unified-video-analyzer.provider.ts` | Single Gemini call for audio + video analysis |
| `src/providers/implementations/gemini-unified-video-analyzer.provider.test.ts` | Tests for unified analyzer |
| `src/processors/impl/gemini/gemini-unified-video-analyzer.ts` | Processor that combines 6 steps into 1 |
| `src/templates/gemini-unified-video-prompt.ts` | Combined prompt for audio + video analysis |
| `src/providers/interfaces/unified-video-analyzer.provider.ts` | Interface definition |

### API Integrations

#### Stability AI Replace Background and Relight API

```
POST /v2beta/stable-image/edit/replace-background-and-relight
```

Features:
- AI-generated backgrounds from text prompts
- Lighting adjustment with configurable direction and strength
- Preserves original subject with configurable strength (0.0-1.0)
- Supports foreground and negative prompts

#### Stability AI Upscale APIs

```
POST /v1/generation/esrgan-v1-x2plus/image-to-image  (conservative)
POST /v2beta/stable-image/upscale/creative           (creative)
```

- Conservative: Fast 2x upscale, preserves original details
- Creative: AI-enhanced upscale with optional prompt guidance
- Automatically selects based on `creativity` parameter (>0.5 = creative)

### Shared Stability API Utilities

New `src/providers/utils/stability-api.ts` module provides:

```typescript
// Sync API request with retry logic
makeStabilityRequest(options: StabilityRequestOptions): Promise<Buffer>

// Async API request with polling for results
makeStabilityAsyncRequest(options: StabilityAsyncRequestOptions): Promise<Buffer>

// Hex color parsing with validation
parseHexColor(hex: string): { r: number; g: number; b: number; alpha: number }

// File size validation
isWithinSizeLimit(sizeBytes: number): boolean
getFileSizeError(sizeBytes: number): string
```

### New Pipeline Templates

| Template ID | Description |
|-------------|-------------|
| `stability_bg_removal` | Uses Stability AI for background removal |
| `unified_video_analyzer` | Single Gemini call for audio + video, most efficient |
| `unified_video_analyzer_minimal` | Unified analysis without commercial generation |

### Configuration

New environment variables:

| Variable | Default | Description |
|----------|---------|-------------|
| `STABILITY_API_KEY` | - | Stability AI API key |
| `STABILITY_API_BASE` | `https://api.stability.ai` | Stability API base URL |
| `VOPI_CONCURRENCY_STABILITY_COMMERCIAL` | 3 | Commercial generation parallelism |
| `VOPI_CONCURRENCY_STABILITY_UPSCALE` | 4 | Upscale parallelism |
| `VOPI_CONCURRENCY_STABILITY_BG_REMOVE` | 4 | Background removal parallelism |

### Files Modified

| File | Changes |
|------|---------|
| `src/processors/templates/index.ts` | Changed `generate-commercial` to `stability-commercial`, added `stability-upscale` to pipelines |
| `src/processors/templates/index.test.ts` | Updated expected processor order for stability changes |
| `src/providers/implementations/index.ts` | Export new Stability providers |
| `src/processors/impl/index.ts` | Register new Stability processors |
| `src/processors/concurrency.ts` | Added `STABILITY_COMMERCIAL`, `STABILITY_UPSCALE`, `STABILITY_BG_REMOVE` keys |

---

## Session 7: Code Review Fixes

### Issues Identified and Fixed

1. **parseHexColor validation** - Fixed whitespace handling: `hex.replace(/^#/, '').trim()` → `hex.trim().replace(/^#/, '')`

2. **Unsafe JSON parsing** - Added explicit type annotation for `resultId` in async response handling

3. **Redundant nullish coalescing** - Removed `?? defaultValue` where `getConcurrency()` already returns defaults

4. **Logger mock in tests** - Added logger mock to test files to prevent config loading errors

### Test Results (Final)

```
All 1023 tests passing across 52 test files
- Stability API tests: 19 passing
- Stability Commercial Provider tests: 13 passing
- Stability Upscale Provider tests: 12 passing
- Template tests: 49 passing
```

---

## Summary of All Sessions

| Session | Focus | Key Changes |
|---------|-------|-------------|
| 1 | Centralized Concurrency | Created `concurrency.ts`, migrated 5 processors |
| 2 | Performance Optimization | Parallel Gemini batches, parallel S3 uploads, keep-alive |
| 3 | Quality Filtering | Minimum sharpness threshold to reject blurry frames |
| 4 | Code Quality | O(n²) → O(n) optimization, documentation fixes |
| 5 | Transcoding Optimization | 5-10x faster HEVC→H.264 transcoding, timeout protection |
| 6 | Stability AI Integration | Commercial image generation, upscaling, background removal with Stability AI |
| 7 | Code Review Fixes | parseHexColor validation, test mocks, redundant code cleanup |
