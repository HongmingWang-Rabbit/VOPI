# Edit History - January 26, 2026

## Session Summary

This session focused on **authentication error improvements** to make debugging easier for frontend developers.

### Major Changes

1. **Specific Auth Error Codes** - Created comprehensive error code system for JWT and API key authentication
2. **New Auth Errors Module** - Added `src/utils/auth-errors.ts` with typed error classes
3. **Improved Error Diagnostics** - Auth middleware and routes now return specific error codes instead of generic ones
4. **Better Logging** - Auth failures are logged with full context for debugging

### Error Code System

| Category | Error Codes |
|----------|-------------|
| Access Token | `ACCESS_TOKEN_EXPIRED`, `ACCESS_TOKEN_INVALID`, `ACCESS_TOKEN_MALFORMED`, `ACCESS_TOKEN_WRONG_TYPE` |
| Refresh Token | `REFRESH_TOKEN_EXPIRED`, `REFRESH_TOKEN_INVALID`, `REFRESH_TOKEN_REVOKED`, `REFRESH_TOKEN_REUSED`, `REFRESH_TOKEN_WRONG_TYPE` |
| User | `USER_NOT_FOUND`, `USER_DELETED` |
| OAuth | `OAUTH_STATE_INVALID`, `OAUTH_STATE_EXPIRED`, `OAUTH_PROVIDER_MISMATCH` |
| Config | `JWT_SECRET_NOT_CONFIGURED` |

---

## Files Created

### Auth Infrastructure

| File | Description |
|------|-------------|
| `src/utils/auth-errors.ts` | Typed auth error classes with specific error codes |

---

## Files Modified

### Auth Service

| File | Changes |
|------|---------|
| `src/services/auth.service.ts` | - Use specific error classes instead of generic `Error()` |
|                                 | - `verifyAccessToken()` throws `AccessTokenExpiredError`, `AccessTokenInvalidError`, `AccessTokenWrongTypeError` |
|                                 | - `refreshAccessToken()` throws `RefreshTokenExpiredError`, `RefreshTokenRevokedError`, `RefreshTokenReusedError` |
|                                 | - User lookup throws `UserNotFoundError`, `UserDeletedError` |

### Auth Middleware

| File | Changes |
|------|---------|
| `src/middleware/auth.middleware.ts` | - Import new auth error types |
|                                      | - `tryJwtAuth()` returns specific `AuthError` instances |
|                                      | - `authMiddleware()` returns specific error codes to client |
|                                      | - Improved error message: "Authentication required. Provide a valid Bearer token or API key." |

### Auth Routes

| File | Changes |
|------|---------|
| `src/routes/auth.routes.ts` | - Import `formatAuthError` helper |
|                              | - `/auth/refresh` endpoint returns specific error codes |
|                              | - Added logging with error context for debugging |

### Tests

| File | Changes |
|------|---------|
| `src/middleware/auth.middleware.test.ts` | - Updated test expectations for new error message |

---

## Auth Error Classes

### Module: `src/utils/auth-errors.ts`

The new auth errors module provides:
- **Specific error codes** for each failure scenario
- **Typed error classes** extending `UnauthorizedError` (401)
- **Optional context** for debugging (userId, expiration time, etc.)
- **`formatAuthError()` helper** for consistent error formatting

### Error Class Hierarchy

```typescript
AuthError extends UnauthorizedError
├── AccessTokenExpiredError
├── AccessTokenInvalidError
├── AccessTokenMalformedError
├── AccessTokenWrongTypeError
├── RefreshTokenExpiredError
├── RefreshTokenInvalidError
├── RefreshTokenRevokedError
├── RefreshTokenReusedError
├── RefreshTokenWrongTypeError
├── UserNotFoundError
├── UserDeletedError
├── JwtSecretNotConfiguredError
└── OAuthStateError
```

### Usage in Service

```typescript
// Before (generic errors)
throw new Error('Token expired');
throw new Error('Invalid refresh token');
throw new Error('User not found');

// After (specific errors)
throw new AccessTokenExpiredError(error.expiredAt);
throw new RefreshTokenRevokedError(decoded.sub);
throw new UserNotFoundError(userId);
```

### Client Response Format

```json
{
  "error": "REFRESH_TOKEN_EXPIRED",
  "message": "Refresh token has expired"
}
```

---

## API Response Changes

### Before

All auth failures returned generic error:
```json
{
  "error": "INVALID_TOKEN",
  "message": "Invalid refresh token"
}
```

### After

Specific error codes for each scenario:

| Scenario | Error Code | Message |
|----------|------------|---------|
| Access token expired | `ACCESS_TOKEN_EXPIRED` | "Access token has expired" |
| Access token invalid signature | `ACCESS_TOKEN_INVALID` | "Access token is invalid: {reason}" |
| Access token malformed | `ACCESS_TOKEN_MALFORMED` | "Access token is malformed: {reason}" |
| Wrong token type | `ACCESS_TOKEN_WRONG_TYPE` | "Expected access token, got {type}" |
| Refresh token expired | `REFRESH_TOKEN_EXPIRED` | "Refresh token has expired" |
| Refresh token revoked | `REFRESH_TOKEN_REVOKED` | "Refresh token has been revoked" |
| Refresh token reused | `REFRESH_TOKEN_REUSED` | "Refresh token has already been used..." |
| User not found | `USER_NOT_FOUND` | "User account not found" |
| User deleted | `USER_DELETED` | "User account has been deleted" |
| No auth provided | `UNAUTHORIZED` | "Authentication required. Provide a valid Bearer token or API key." |

---

## Git Commits

| Commit | Message |
|--------|---------|
| `50e41dc` | feat: add specific auth error codes for easier debugging |
