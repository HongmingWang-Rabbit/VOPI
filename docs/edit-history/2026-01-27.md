# Edit History - January 27, 2026

## Session Summary

This session added **job deletion and per-image deletion APIs**, plus code review fixes for robustness and correctness.

### Major Changes

1. **Job Deletion Endpoint** - `DELETE /api/v1/jobs/:id` now fully deletes a job (S3 artifacts + DB cascade) instead of cancelling
2. **Per-Image Deletion Endpoint** - `DELETE /api/v1/jobs/:id/images/:frameId/:version` removes a single commercial image variant
3. **Cancel Endpoint Moved** - Job cancellation moved from `DELETE /jobs/:id` to `POST /jobs/:id/cancel` (breaking change)
4. **S3 Pagination Fix** - `StorageService.listFiles()` now handles >1000 objects via `ContinuationToken`
5. **Code Review Fixes** - Type safety, error handling, and import improvements

---

## Files Modified

### Storage Service

| File | Changes |
|------|---------|
| `src/services/storage.service.ts` | - `listFiles()` now paginates with `ContinuationToken` for >1000 objects |
|                                     | - Added `deletePrefix()` method for bulk S3 deletion under a prefix |

### Jobs Controller

| File | Changes |
|------|---------|
| `src/controllers/jobs.controller.ts` | - `deleteJob()` now cleans up S3 artifacts before DB deletion |
|                                       | - `deleteJob()` rejects actively processing jobs with 409 Conflict |
|                                       | - `deleteJob()` uses terminal status allowlist instead of active status blocklist |
|                                       | - `deleteJob()` handles S3 cleanup failure gracefully (best-effort) |
|                                       | - Added `deleteJobImage()` for per-image variant deletion |
|                                       | - Replaced dynamic `await import()` calls with static top-level imports |
|                                       | - Added type validation for `commercialImages` structure |
|                                       | - Added warning log when S3 key can't be extracted from image URL |

### Jobs Routes

| File | Changes |
|------|---------|
| `src/routes/jobs.routes.ts` | - Moved cancel from `DELETE /jobs/:id` to `POST /jobs/:id/cancel` |
|                               | - `DELETE /jobs/:id` now performs full job deletion (204 No Content) |
|                               | - Added `DELETE /jobs/:id/images/:frameId/:version` route |
|                               | - Added `imageDeleteParamsSchema` Zod schema extending `jobIdParamsSchema` |

### Documentation

| File | Changes |
|------|---------|
| `docs/api.md` | - Updated `DELETE /api/v1/jobs/:id` docs (now deletion, not cancellation) |
|                | - Added `POST /api/v1/jobs/:id/cancel` docs |
|                | - Added `DELETE /api/v1/jobs/:id/images/:frameId/:version` docs |
|                | - Added 409 Conflict to common status codes table |

---

## Breaking Changes

| Change | Migration |
|--------|-----------|
| `DELETE /jobs/:id` no longer cancels â€” it deletes | Use `POST /jobs/:id/cancel` for cancellation |

---

## New API Endpoints

| Method | Path | Description |
|--------|------|-------------|
| `POST` | `/api/v1/jobs/:id/cancel` | Cancel a pending job |
| `DELETE` | `/api/v1/jobs/:id` | Delete job + S3 artifacts (terminal/pending only) |
| `DELETE` | `/api/v1/jobs/:id/images/:frameId/:version` | Delete a single commercial image variant |
