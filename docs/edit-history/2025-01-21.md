# Edit History - January 21, 2025

## Session Summary

This session focused on implementing the Gemini Video Strategy for direct video analysis, adding a global configuration system with admin controls, and fixing critical bugs around video processing and job retries.

### Major Features Added

1. **Gemini Video Analysis Provider** - Direct video-to-frame selection using Gemini's video understanding capabilities
2. **Automatic HEVC Transcoding** - Seamless handling of iPhone HEVC videos by auto-converting to H.264
3. **Global Config Service** - Database-backed runtime configuration with caching and admin API
4. **Admin Authorization** - Secure config management with ADMIN_API_KEYS

### Bug Fixes

1. **S3 Retry Issue** - Fixed uploaded video being deleted on failure, breaking automatic job retries
2. **HEVC Processing Failure** - Added automatic transcoding for unsupported HEVC codec

---

## Files Created

### Providers

| File | Description |
|------|-------------|
| `src/providers/implementations/gemini-video-analysis.provider.ts` | Gemini video analysis with HEVC transcoding |
| `src/providers/implementations/gemini-video-analysis.provider.test.ts` | Tests for video analysis provider |
| `src/providers/interfaces/video-analysis.provider.ts` | Interface for video analysis providers |

### Services

| File | Description |
|------|-------------|
| `src/services/global-config.service.ts` | Runtime config management with caching |
| `src/services/global-config.service.test.ts` | Tests for global config service |

### Routes

| File | Description |
|------|-------------|
| `src/routes/config.routes.ts` | REST API for config CRUD operations |
| `src/routes/config.routes.test.ts` | Tests for config routes |

### Types & Templates

| File | Description |
|------|-------------|
| `src/types/config.types.ts` | Type definitions and default config values |
| `src/templates/gemini-video-system-prompt.ts` | Extracted prompt template for video analysis |

---

## Files Modified

### Core Services

| File | Changes |
|------|---------|
| `src/services/pipeline.service.ts` | Added Gemini video strategy; fixed S3 cleanup to only run on success |
| `src/services/pipeline.service.test.ts` | Added tests for new pipeline features |

### Configuration

| File | Changes |
|------|---------|
| `src/config/env.ts` | Added ADMIN_API_KEYS and CONFIG_CACHE_TTL_MS |
| `src/config/index.ts` | Added adminApiKeys and configCache settings |

### Middleware

| File | Changes |
|------|---------|
| `src/middleware/auth.middleware.ts` | Added requireAdmin() and isAdminRequest() functions |

### Database

| File | Changes |
|------|---------|
| `src/db/schema.ts` | Added globalConfig table for runtime configuration |

### Application

| File | Changes |
|------|---------|
| `src/app.ts` | Registered config routes |
| `src/providers/implementations/index.ts` | Exported video analysis provider |
| `src/providers/interfaces/index.ts` | Exported video analysis interface |

---

## New Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `ADMIN_API_KEYS` | Comma-separated list of admin API keys | (empty) |
| `CONFIG_CACHE_TTL_MS` | Config cache time-to-live in milliseconds | 60000 |

---

## New API Endpoints

### Config Management (Admin Only)

| Method | Path | Description |
|--------|------|-------------|
| `GET` | `/api/v1/config` | Get all config values with metadata |
| `GET` | `/api/v1/config/effective` | Get effective runtime config |
| `GET` | `/api/v1/config/:key` | Get single config value |
| `PUT` | `/api/v1/config` | Set config value (admin) |
| `PUT` | `/api/v1/config/batch` | Set multiple config values (admin) |
| `DELETE` | `/api/v1/config/:key` | Delete config value (admin) |
| `POST` | `/api/v1/config/seed` | Seed default values (admin) |
| `POST` | `/api/v1/config/invalidate-cache` | Invalidate config cache (admin) |

---

## Pipeline Strategies

The pipeline now supports two strategies controlled by `pipeline.strategy` config:

### Classic Strategy (default)
1. Download video
2. Extract all frames with FFmpeg
3. Score frames (sharpness + motion)
4. Classify top candidates with Gemini
5. Generate commercial images
6. Upload to S3

### Gemini Video Strategy
1. Download video
2. Auto-transcode HEVC to H.264 if needed
3. Upload to Gemini Files API
4. Analyze video directly with Gemini
5. Extract frames at selected timestamps
6. Generate commercial images
7. Upload to S3

---

## Global Config Keys

| Key | Type | Default | Description |
|-----|------|---------|-------------|
| `pipeline.strategy` | string | `classic` | Pipeline strategy (classic/gemini_video) |
| `pipeline.fps` | number | 10 | Frame extraction rate |
| `pipeline.batchSize` | number | 30 | Frames per batch |
| `ai.geminiModel` | string | `gemini-2.0-flash` | Gemini model for classification |
| `ai.geminiVideoModel` | string | `gemini-2.0-flash` | Gemini model for video analysis |
| `ai.temperature` | number | 0.2 | AI temperature setting |
| `ai.topP` | number | 0.8 | AI top-p setting |
| `scoring.motionAlpha` | number | 0.3 | Motion penalty weight |
| `scoring.minTemporalGap` | number | 1.0 | Min seconds between frames |
| `scoring.topKPercent` | number | 0.3 | Top percentage for candidates |
| `commercial.versions` | array | `["transparent","solid","real","creative"]` | Commercial image versions |
| `commercial.aiCleanup` | boolean | true | Enable AI cleanup |
| `geminiVideo.fps` | number | 1 | Video analysis FPS |
| `geminiVideo.maxFrames` | number | 10 | Max frames to select |

---

## Technical Details

### HEVC Auto-Transcoding

When a video with HEVC (H.265) codec is detected:
1. `ffprobe` checks the video codec
2. If HEVC, `ffmpeg` transcodes to H.264 with `-preset fast -crf 23`
3. Transcoded file is uploaded to Gemini
4. Cleanup removes transcoded file after analysis

### S3 Retry Fix

Previously, the pipeline cleanup deleted the uploaded video on both success and failure:
```typescript
// Before (broken)
} finally {
  await this.cleanupUploadedVideo(ctx.job.videoUrl);
}
```

Now cleanup only runs on success:
```typescript
// After (fixed)
result = await this.runStrategy(ctx);
await this.cleanupUploadedVideo(ctx.job.videoUrl); // Only on success
return result;
```

This allows BullMQ automatic retries to work correctly.

---

## Test Results

All 402 tests passing after changes.
