# Edit History - January 22, 2026

## Session Summary

This session focused on implementing a **Composable Process Stack Architecture** that replaces the rigid pipeline with modular, swappable processors. This enables flexible workflow composition through simple IO type contracts (`video`, `images`, `text`, `metadata`).

### Major Features Added

1. **Composable Processor Stack Architecture** - New modular system where processors declare IO types and can be composed into pipelines
2. **Processor Registry** - Central registry for processor implementations with IO compatibility checking
3. **Stack Runner** - Executes processor stacks with validation, swapping, and insertion support
4. **15 Processor Implementations** - All pipeline steps as individual, swappable processors
5. **Stack Templates** - Pre-defined stacks for common workflows (classic, gemini_video, minimal, etc.)
6. **Comprehensive Test Suite** - 145 new tests covering all processor architecture components

---

## Files Created

### Core Processor Infrastructure

| File | Description |
|------|-------------|
| `src/processors/types.ts` | IOType, Processor, Stack interfaces |
| `src/processors/registry.ts` | ProcessorRegistry for managing processor instances |
| `src/processors/runner.ts` | StackRunner with validation and execution |
| `src/processors/constants.ts` | Progress constants, defaults, calculateProgress utility |
| `src/processors/setup.ts` | Processor registration on app startup |
| `src/processors/index.ts` | Module exports |

### Processor Implementations

| File | Description |
|------|-------------|
| `src/processors/impl/download.ts` | Downloads video from URL |
| `src/processors/impl/extract-frames.ts` | Extracts frames using FFmpeg |
| `src/processors/impl/gemini-video-analysis.ts` | Direct video analysis with Gemini |
| `src/processors/impl/score-frames.ts` | Calculates sharpness and motion scores |
| `src/processors/impl/gemini-classify.ts` | AI classification of frames |
| `src/processors/impl/filter-by-score.ts` | Filters frames by quality score |
| `src/processors/impl/extract-products.ts` | Removes background and centers product |
| `src/processors/impl/photoroom-bg-remove.ts` | Background removal via Photoroom |
| `src/processors/impl/claid-bg-remove.ts` | Background removal via Claid (swappable) |
| `src/processors/impl/center-product.ts` | Centers product in frame |
| `src/processors/impl/rotate-image.ts` | Rotates images |
| `src/processors/impl/save-frame-records.ts` | Persists frame records to database |
| `src/processors/impl/upload-frames.ts` | Uploads frames to S3 |
| `src/processors/impl/generate-commercial.ts` | Generates commercial image versions |
| `src/processors/impl/complete-job.ts` | Completes job and triggers callbacks |
| `src/processors/impl/index.ts` | Exports all processors |

### Stack Templates

| File | Description |
|------|-------------|
| `src/processors/templates/index.ts` | Pre-defined stack templates (classic, gemini_video, minimal, frames_only, custom_bg_removal) |

### Utilities

| File | Description |
|------|-------------|
| `src/processors/utils/video-record.ts` | Shared utility for saving video records |

### Test Files

| File | Tests | Description |
|------|-------|-------------|
| `src/processors/registry.test.ts` | 21 | ProcessorRegistry tests |
| `src/processors/runner.test.ts` | 22 | StackRunner tests |
| `src/processors/templates/index.test.ts` | 42 | Stack template tests |
| `src/processors/constants.test.ts` | 18 | Constants and utility tests |
| `src/processors/setup.test.ts` | 10 | Setup and verification tests |
| `src/processors/integration.test.ts` | 19 | Integration tests with real processors |
| `src/processors/impl/filter-by-score.test.ts` | 13 | Filter-by-score processor tests |

---

## Files Modified

### Type Definitions

| File | Changes |
|------|---------|
| `src/types/job.types.ts` | Added StackConfig schema for processor swaps, insertions, and options |

### Services

| File | Changes |
|------|---------|
| `src/services/pipeline.service.ts` | Added `runPipelineWithStack()` method for stack-based execution |

### Workers

| File | Changes |
|------|---------|
| `src/workers/index.ts` | Added `setupProcessors()` initialization call |

---

## Architecture Changes

### Composable Process Stack

The new architecture replaces the monolithic pipeline with modular processors:

```
┌─────────────────────────────────────────────────────────────────┐
│                        Stack Template                            │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐            │
│  │download │→│extract  │→│ score   │→│classify │→ ...         │
│  │ →video  │  │video→img│  │img→img │  │img→meta│              │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘            │
└─────────────────────────────────────────────────────────────────┘
```

### IO Type System

Processors declare what they require and produce:
- `video` - Video file path
- `images` - Array of image paths
- `text` - Text/JSON data
- `metadata` - Structured metadata

Any processor that outputs `images` can connect to any processor that requires `images`.

### Processor IO Contracts

| Processor | Requires | Produces |
|-----------|----------|----------|
| download | - | video |
| extract-frames | video | images |
| gemini-video-analysis | video | images, metadata |
| score-frames | images | images, metadata |
| gemini-classify | images | metadata |
| filter-by-score | images, metadata | images |
| photoroom-bg-remove | images | images |
| claid-bg-remove | images | images |
| center-product | images | images |
| rotate-image | images | images |
| extract-products | images | images |
| upload-frames | images | text |
| generate-commercial | images | images |
| save-frame-records | metadata | - |
| complete-job | - | - |

### Stack Configuration

Jobs can customize stacks via `StackConfig`:

```typescript
interface StackConfig {
  stackId?: string;                    // Which template to use
  processorSwaps?: Record<string, string>;  // Swap processors
  processorOptions?: Record<string, Record<string, unknown>>;  // Override options
  insertProcessors?: Array<{
    after: string;
    processor: string;
    options?: Record<string, unknown>;
  }>;
}
```

### Pre-defined Stacks

| Stack ID | Description |
|----------|-------------|
| `classic` | Full pipeline with frame extraction, scoring, classification |
| `gemini_video` | Direct video analysis with Gemini |
| `minimal` | Extract and upload without commercial generation |
| `frames_only` | Extract frames with scoring, no AI classification |
| `custom_bg_removal` | Configurable background removal provider |

---

## Test Results

All 568 tests passing after changes (145 new tests added).

---

## Technical Details

### Stack Validation

The StackRunner validates stacks before execution:
1. Checks all processors exist in registry
2. Verifies IO flow (each processor's requirements are satisfied)
3. Validates processor swaps have compatible IO contracts

### Processor Swapping

Processors with the same IO contract are swappable:
```typescript
// Both have: requires: ['images'], produces: ['images']
processorSwaps: {
  'photoroom-bg-remove': 'claid-bg-remove'
}
```

### Partial Failure Handling

The `generate-commercial` processor now tracks partial failures:
```typescript
commercialGenerationStats: {
  totalFrames: number;
  successfulFrames: number;
  totalErrors: number;
  totalImagesGenerated: number;
}
```

---

## Session 2: Claid Provider & S3 Presign Utilities

### Summary

Added Claid.ai as an alternative background removal provider with shared S3 presigned URL utilities. This enables processor swapping between Photoroom and Claid for background removal.

### Files Created

| File | Description |
|------|-------------|
| `src/providers/implementations/claid-background-removal.provider.ts` | Claid.ai background removal implementation |
| `src/providers/implementations/claid-background-removal.provider.test.ts` | 18 tests for Claid provider |
| `src/utils/s3-presign.ts` | Shared S3 presigned URL utilities |

### Files Modified

| File | Changes |
|------|---------|
| `src/services/photoroom.service.ts` | Refactored to use shared s3-presign utilities |
| `src/services/photoroom.service.test.ts` | Added 7 tests for presigned URL mode |
| `src/config/env.ts` | Added `API_PRESIGN_EXPIRY_SECONDS` config |
| `src/config/index.ts` | Added `apiPresign` config section |
| `.env.example` | Added presign config documentation |
| `src/providers/implementations/index.ts` | Export Claid provider |
| `src/providers/setup.ts` | Register Claid provider |

### Features Added

1. **Claid Background Removal Provider**
   - Uses Claid.ai API for selective background removal
   - Supports "guided removal" with object-to-keep prompt
   - Dual-mode: presigned URL (production) or multipart upload (local dev)
   - Retry logic with exponential backoff
   - Optional inpainting for hole filling

2. **Shared S3 Presigned URL Utilities** (`src/utils/s3-presign.ts`)
   - `isLocalS3()` - Detect localhost S3 (MinIO) vs production
   - `getPresignedImageUrl()` - Upload file and get presigned URL
   - `cleanupTempS3File()` - Clean up temporary files
   - Supports IPv6 localhost (`::1`)

3. **Configurable Presign Expiry**
   - `API_PRESIGN_EXPIRY_SECONDS` env var (default: 300)
   - Used by both Photoroom and Claid

### Bug Fixes & Improvements

1. **gemini-classify processor** - Now returns error when all batches fail or no variants discovered
2. **generate-commercial processor** - Removed unused `_frameId` parameter
3. **claid-bg-remove processor** - Fixed type assertion by adding `rotationApplied: 0`
4. **fill-product-holes.test.ts** - Removed unused imports

### Test Results

All 639 tests passing (33 test files).

### Claid Provider Details

```typescript
// IO Contract (same as Photoroom)
io: {
  requires: ['images', 'frames'],
  produces: ['images'],
}

// Usage in stack config
{
  processorSwaps: {
    'photoroom-bg-remove': 'claid-bg-remove'
  }
}
```

### S3 Presign Utility

```typescript
// Check if S3 is local (MinIO)
isLocalS3(): boolean

// Get presigned URL for external API
getPresignedImageUrl(imagePath, prefix, expirySeconds?): Promise<{url, tempKey}>

// Clean up temp file
cleanupTempS3File(tempKey): Promise<void>
```
