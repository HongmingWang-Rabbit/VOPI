# Edit History - January 22, 2026

## Session Summary

This session focused on implementing a **Composable Process Stack Architecture** that replaces the rigid pipeline with modular, swappable processors. This enables flexible workflow composition through simple IO type contracts (`video`, `images`, `text`, `metadata`).

### Major Features Added

1. **Composable Processor Stack Architecture** - New modular system where processors declare IO types and can be composed into pipelines
2. **Processor Registry** - Central registry for processor implementations with IO compatibility checking
3. **Stack Runner** - Executes processor stacks with validation, swapping, and insertion support
4. **15 Processor Implementations** - All pipeline steps as individual, swappable processors
5. **Stack Templates** - Pre-defined stacks for common workflows (classic, gemini_video, minimal, etc.)
6. **Comprehensive Test Suite** - 145 new tests covering all processor architecture components

---

## Files Created

### Core Processor Infrastructure

| File | Description |
|------|-------------|
| `src/processors/types.ts` | IOType, Processor, Stack interfaces |
| `src/processors/registry.ts` | ProcessorRegistry for managing processor instances |
| `src/processors/runner.ts` | StackRunner with validation and execution |
| `src/processors/constants.ts` | Progress constants, defaults, calculateProgress utility |
| `src/processors/setup.ts` | Processor registration on app startup |
| `src/processors/index.ts` | Module exports |

### Processor Implementations

| File | Description |
|------|-------------|
| `src/processors/impl/download.ts` | Downloads video from URL |
| `src/processors/impl/extract-frames.ts` | Extracts frames using FFmpeg |
| `src/processors/impl/gemini-video-analysis.ts` | Direct video analysis with Gemini |
| `src/processors/impl/score-frames.ts` | Calculates sharpness and motion scores |
| `src/processors/impl/gemini-classify.ts` | AI classification of frames |
| `src/processors/impl/filter-by-score.ts` | Filters frames by quality score |
| `src/processors/impl/extract-products.ts` | Removes background and centers product |
| `src/processors/impl/photoroom-bg-remove.ts` | Background removal via Photoroom |
| `src/processors/impl/claid-bg-remove.ts` | Background removal via Claid (swappable) |
| `src/processors/impl/center-product.ts` | Centers product in frame |
| `src/processors/impl/rotate-image.ts` | Rotates images |
| `src/processors/impl/save-frame-records.ts` | Persists frame records to database |
| `src/processors/impl/upload-frames.ts` | Uploads frames to S3 |
| `src/processors/impl/generate-commercial.ts` | Generates commercial image versions |
| `src/processors/impl/complete-job.ts` | Completes job and triggers callbacks |
| `src/processors/impl/index.ts` | Exports all processors |

### Stack Templates

| File | Description |
|------|-------------|
| `src/processors/templates/index.ts` | Pre-defined stack templates (classic, gemini_video, minimal, frames_only, custom_bg_removal) |

### Utilities

| File | Description |
|------|-------------|
| `src/processors/utils/video-record.ts` | Shared utility for saving video records |

### Test Files

| File | Tests | Description |
|------|-------|-------------|
| `src/processors/registry.test.ts` | 21 | ProcessorRegistry tests |
| `src/processors/runner.test.ts` | 22 | StackRunner tests |
| `src/processors/templates/index.test.ts` | 42 | Stack template tests |
| `src/processors/constants.test.ts` | 18 | Constants and utility tests |
| `src/processors/setup.test.ts` | 10 | Setup and verification tests |
| `src/processors/integration.test.ts` | 19 | Integration tests with real processors |
| `src/processors/impl/filter-by-score.test.ts` | 13 | Filter-by-score processor tests |

---

## Files Modified

### Type Definitions

| File | Changes |
|------|---------|
| `src/types/job.types.ts` | Added StackConfig schema for processor swaps, insertions, and options |

### Services

| File | Changes |
|------|---------|
| `src/services/pipeline.service.ts` | Added `runPipelineWithStack()` method for stack-based execution |

### Workers

| File | Changes |
|------|---------|
| `src/workers/index.ts` | Added `setupProcessors()` initialization call |

---

## Architecture Changes

### Composable Process Stack

The new architecture replaces the monolithic pipeline with modular processors:

```
┌─────────────────────────────────────────────────────────────────┐
│                        Stack Template                            │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐            │
│  │download │→│extract  │→│ score   │→│classify │→ ...         │
│  │ →video  │  │video→img│  │img→img │  │img→meta│              │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘            │
└─────────────────────────────────────────────────────────────────┘
```

### IO Type System

Processors declare what they require and produce:
- `video` - Video file path
- `images` - Array of image paths
- `text` - Text/JSON data
- `metadata` - Structured metadata

Any processor that outputs `images` can connect to any processor that requires `images`.

### Processor IO Contracts

| Processor | Requires | Produces |
|-----------|----------|----------|
| download | - | video |
| extract-frames | video | images |
| gemini-video-analysis | video | images, metadata |
| score-frames | images | images, metadata |
| gemini-classify | images | metadata |
| filter-by-score | images, metadata | images |
| photoroom-bg-remove | images | images |
| claid-bg-remove | images | images |
| center-product | images | images |
| rotate-image | images | images |
| extract-products | images | images |
| upload-frames | images | text |
| generate-commercial | images | images |
| save-frame-records | metadata | - |
| complete-job | - | - |

### Stack Configuration

Jobs can customize stacks via `StackConfig`:

```typescript
interface StackConfig {
  stackId?: string;                    // Which template to use
  processorSwaps?: Record<string, string>;  // Swap processors
  processorOptions?: Record<string, Record<string, unknown>>;  // Override options
  insertProcessors?: Array<{
    after: string;
    processor: string;
    options?: Record<string, unknown>;
  }>;
}
```

### Pre-defined Stacks

| Stack ID | Description |
|----------|-------------|
| `classic` | Full pipeline with frame extraction, scoring, classification |
| `gemini_video` | Direct video analysis with Gemini |
| `minimal` | Extract and upload without commercial generation |
| `frames_only` | Extract frames with scoring, no AI classification |
| `custom_bg_removal` | Configurable background removal provider |

---

## Test Results

All 568 tests passing after changes (145 new tests added).

---

## Technical Details

### Stack Validation

The StackRunner validates stacks before execution:
1. Checks all processors exist in registry
2. Verifies IO flow (each processor's requirements are satisfied)
3. Validates processor swaps have compatible IO contracts

### Processor Swapping

Processors with the same IO contract are swappable:
```typescript
// Both have: requires: ['images'], produces: ['images']
processorSwaps: {
  'photoroom-bg-remove': 'claid-bg-remove'
}
```

### Partial Failure Handling

The `generate-commercial` processor now tracks partial failures:
```typescript
commercialGenerationStats: {
  totalFrames: number;
  successfulFrames: number;
  totalErrors: number;
  totalImagesGenerated: number;
}
```

---

## Session 2: Claid Provider & S3 Presign Utilities

### Summary

Added Claid.ai as an alternative background removal provider with shared S3 presigned URL utilities. This enables processor swapping between Photoroom and Claid for background removal.

### Files Created

| File | Description |
|------|-------------|
| `src/providers/implementations/claid-background-removal.provider.ts` | Claid.ai background removal implementation |
| `src/providers/implementations/claid-background-removal.provider.test.ts` | 18 tests for Claid provider |
| `src/utils/s3-presign.ts` | Shared S3 presigned URL utilities |

### Files Modified

| File | Changes |
|------|---------|
| `src/services/photoroom.service.ts` | Refactored to use shared s3-presign utilities |
| `src/services/photoroom.service.test.ts` | Added 7 tests for presigned URL mode |
| `src/config/env.ts` | Added `API_PRESIGN_EXPIRY_SECONDS` config |
| `src/config/index.ts` | Added `apiPresign` config section |
| `.env.example` | Added presign config documentation |
| `src/providers/implementations/index.ts` | Export Claid provider |
| `src/providers/setup.ts` | Register Claid provider |

### Features Added

1. **Claid Background Removal Provider**
   - Uses Claid.ai API for selective background removal
   - Supports "guided removal" with object-to-keep prompt
   - Dual-mode: presigned URL (production) or multipart upload (local dev)
   - Retry logic with exponential backoff
   - Optional inpainting for hole filling

2. **Shared S3 Presigned URL Utilities** (`src/utils/s3-presign.ts`)
   - `isLocalS3()` - Detect localhost S3 (MinIO) vs production
   - `getPresignedImageUrl()` - Upload file and get presigned URL
   - `cleanupTempS3File()` - Clean up temporary files
   - Supports IPv6 localhost (`::1`)

3. **Configurable Presign Expiry**
   - `API_PRESIGN_EXPIRY_SECONDS` env var (default: 300)
   - Used by both Photoroom and Claid

### Bug Fixes & Improvements

1. **gemini-classify processor** - Now returns error when all batches fail or no variants discovered
2. **generate-commercial processor** - Removed unused `_frameId` parameter
3. **claid-bg-remove processor** - Fixed type assertion by adding `rotationApplied: 0`
4. **fill-product-holes.test.ts** - Removed unused imports

### Test Results

All 639 tests passing (33 test files).

### Claid Provider Details

```typescript
// IO Contract (same as Photoroom)
io: {
  requires: ['images', 'frames'],
  produces: ['images'],
}

// Usage in stack config
{
  processorSwaps: {
    'photoroom-bg-remove': 'claid-bg-remove'
  }
}
```

### S3 Presign Utility

```typescript
// Check if S3 is local (MinIO)
isLocalS3(): boolean

// Get presigned URL for external API
getPresignedImageUrl(imagePath, prefix, expirySeconds?): Promise<{url, tempKey}>

// Clean up temp file
cleanupTempS3File(tempKey): Promise<void>
```

---

## Session 3: Fill Product Holes, Stability AI Integration & Claid Workflow

### Summary

This session focused on implementing hole filling for product images after background removal, integrating Stability AI for inpainting, and switching the classic stack to use Claid workflow for product extraction.

### Major Changes

1. **Fill Product Holes Processor** - Detects and fills transparent holes in product images
2. **Stability AI Service** - Inpainting service for hole filling
3. **Claid Workflow Integration** - Classic stack now uses Claid-based product extraction
4. **Shared File Utilities** - Extracted common utilities to `src/utils/fs.ts`

### Files Created

| File | Description |
|------|-------------|
| `src/services/stability.service.ts` | Stability AI inpainting integration |
| `src/services/stability.service.test.ts` | 10 tests for Stability service |
| `src/processors/impl/sharp/fill-product-holes.ts` | Hole detection and filling processor |
| `src/processors/impl/sharp/fill-product-holes.test.ts` | 18 tests for hole filling |
| `src/utils/fs.ts` | Shared file utilities (`safeUnlink`, `getVariantPath`) |

### Files Modified

| File | Changes |
|------|---------|
| `src/processors/templates/index.ts` | Updated classicStack and geminiVideoStack to use Claid workflow |
| `src/processors/templates/index.test.ts` | Updated test expectations for new stack order |
| `src/processors/impl/index.ts` | Export fillProductHolesProcessor |
| `src/config/env.ts` | Added `STABILITY_API_KEY` config |
| `src/config/index.ts` | Added `stability` to apis config |
| `.env.example` | Added `STABILITY_API_KEY` documentation |
| `CLAUDE.md` | Updated architecture docs to reflect Claid workflow |

### Stack Changes

**Previous Classic Stack:**
```
download → extract-frames → score-frames → gemini-classify →
save-frame-records → extract-products → upload-frames →
generate-commercial → complete-job
```

**New Classic Stack:**
```
download → extract-frames → score-frames → gemini-classify →
save-frame-records → claid-bg-remove → fill-product-holes →
center-product → upload-frames → generate-commercial → complete-job
```

### Algorithm: Convex Hull Hole Detection

The `fill-product-holes` processor uses convex hull algorithm to detect holes:

1. Extract alpha channel from PNG image
2. Sample boundary points of the opaque product region
3. Compute convex hull using Andrew's monotone chain algorithm
4. Use scanline algorithm to fill the hull interior efficiently
5. Any transparent pixel INSIDE the convex hull is a "hole"
6. Send holes to Stability AI for inpainting

```
Convex Hull Approach:

Original (with hole):      Convex Hull:           Hole Detected:
    ███████                 ███████               ...........
   ██░░░░░██               █████████              ..███████..
   ██░░░░░██     →         █████████      →       ..███████..
    ███████                 ███████               ...........

░ = transparent hole inside product
█ = opaque product pixels
```

### Stability AI Integration

```typescript
// Inpainting for hole filling
const stabilityService = new StabilityService();

await stabilityService.inpaintHoles(
  imagePath,    // Source image with holes
  maskPath,     // White=fill, Black=preserve
  outputPath,   // Result
  {
    prompt: 'Fill in the missing parts...',
    debug: false,
    cleanup: true,
  }
);
```

Features:
- v2beta API endpoint for inpainting
- Automatic image resizing (max 4MP, 64px alignment)
- Mask dilation and blur for smooth transitions
- Alpha channel restoration after inpainting
- Retry logic with exponential backoff

### Shared Utilities (`src/utils/fs.ts`)

```typescript
// Safely delete a file (ignores errors)
safeUnlink(filePath: string): Promise<void>

// Generate variant path with suffix
getVariantPath('/path/image.png', '_mask')
// → '/path/image_mask.png'
```

### New Processor IO Contract

| Processor | Requires | Produces | Description |
|-----------|----------|----------|-------------|
| fill-product-holes | images, frames | images | Fills transparent holes via Stability AI |

### Required API Keys

```bash
# .env configuration
CLAID_API_KEY=your-claid-key      # For background removal
STABILITY_API_KEY=your-key         # For hole inpainting
```

### Test Results

All 639+ tests passing after changes.

---

## Session 4: Unified DataPath System & Code Review Fixes

### Summary

This session focused on simplifying the IOType system by unifying `IOType` and `MetadataPath` into a single `DataPath` type. Additionally, all issues from a comprehensive code review were addressed.

### Major Changes

1. **Unified DataPath System** - Simplified from separate IOType + MetadataPath to single DataPath type
2. **ProcessorIO Simplification** - Reduced from 4 arrays to 2 arrays (requires, produces)
3. **Code Review Fixes** - Fixed all warnings and suggestions from comprehensive review

### Architecture Changes

**Previous System (7 IOTypes + separate metadata):**
```typescript
type IOType = 'video' | 'images' | 'text' | 'metadata'
            | 'frames' | 'scores' | 'classifications' | 'frame-records';

interface ProcessorIO {
  requires: IOType[];
  produces: IOType[];
  metadataRequires?: MetadataPath[];
  metadataProduces?: MetadataPath[];
}
```

**New Unified System (10 DataPaths):**
```typescript
type DataPath =
  | 'video' | 'images' | 'text'           // Core data types
  | 'frames' | 'frames.scores' | 'frames.classifications'  // Metadata paths
  | 'frames.dbId' | 'frames.s3Url' | 'frames.version';

interface ProcessorIO {
  requires: DataPath[];
  produces: DataPath[];
}
```

### Files Modified

| File | Changes |
|------|---------|
| `src/processors/types.ts` | Unified DataPath type, simplified ProcessorIO, added validateDataRequirements() |
| `src/processors/runner.ts` | Added inferDataPaths(), updated validate() to take PipelineData |
| `src/processors/registry.ts` | Updated to use DataPath |
| `src/processors/impl/*.ts` | All 15 processors merged metadataRequires/Produces into requires/produces |
| `src/processors/*.test.ts` | Updated tests for new validation signature |

### Code Review Fixes

**Warnings Fixed:**
| Issue | File | Fix |
|-------|------|-----|
| Index signature issues | `types.ts` | Added explicit `extensions` field with documentation |
| Empty array fallback chain | `save-frame-records.ts:43` | Changed to check `?.length` before fallback |
| Hardcoded Stability API URL | `stability.service.ts` | Moved to config via `STABILITY_API_BASE` env var |

**Suggestions Fixed:**
| Issue | File | Fix |
|-------|------|-----|
| Deprecated type aliases | `types.ts:46-52` | Added removal timeline ("v3.0") |
| Missing @deprecated JSDoc | `runner.ts:366-372` | Added full JSDoc with migration guidance |
| Boundary sample not configurable | `fill-product-holes.ts` | Made configurable via `boundarySampleTarget` option |
| Batch size default | `gemini-classify.ts:57` | Added explicit default: `?? 20` |
| Silent skip when unavailable | `claid-bg-remove.ts:39` | Changed to INFO level, added `skip: true` flag |

**Config Changes:**
| Variable | Description |
|----------|-------------|
| `STABILITY_API_BASE` | Stability AI API base URL (default: `https://api.stability.ai`) |

### Updated Processor IO Contracts

| Processor | requires | produces |
|-----------|----------|----------|
| download | ['video'] | ['video'] |
| extract-frames | ['video'] | ['images', 'frames'] |
| gemini-video-analysis | ['video'] | ['images', 'frames', 'frames.classifications'] |
| score-frames | ['images', 'frames'] | ['images', 'frames.scores'] |
| gemini-classify | ['images', 'frames'] | ['frames.classifications'] |
| filter-by-score | ['images', 'frames', 'frames.scores'] | ['images'] |
| save-frame-records | ['frames'] | ['frames.dbId'] |
| photoroom-bg-remove | ['images', 'frames'] | ['images'] |
| claid-bg-remove | ['images', 'frames'] | ['images'] |
| fill-product-holes | ['images', 'frames'] | ['images'] |
| center-product | ['images', 'frames'] | ['images'] |
| rotate-image | ['images', 'frames'] | ['images'] |
| upload-frames | ['images', 'frames'] | ['text', 'frames.s3Url'] |
| generate-commercial | ['images', 'frames'] | ['images', 'frames.version'] |
| complete-job | [] | [] |

### Test Results

All 213 processor tests passing after changes.

---

## Session 5: Audio Transcription & E-commerce Metadata Extraction Pipeline

### Summary

This session implemented a complete audio analysis pipeline that extracts audio from product videos, transcribes it using Gemini 2.0 Flash, and generates structured e-commerce metadata for Shopify, Amazon, and eBay platforms.

### Major Features Added

1. **Audio Extraction Processor** - FFmpeg-based audio extraction optimized for speech recognition (16kHz mono MP3)
2. **Gemini Audio Analysis** - Transcription and product metadata extraction using Gemini's native audio understanding
3. **Product Metadata Types** - Comprehensive type system for multi-platform e-commerce metadata
4. **Platform Formatters** - Automatic conversion to Shopify, Amazon, and eBay formats
5. **Zod Validation** - Schema validation for Gemini API responses
6. **Shared Utilities** - MIME type detection, parallel processing, centralized constants

### Files Created

#### Processors

| File | Description |
|------|-------------|
| `src/processors/impl/ffmpeg/extract-audio.ts` | Extracts audio track from video using FFmpeg |
| `src/processors/impl/gemini/gemini-audio-analysis.ts` | Transcription + product metadata extraction |

#### Providers

| File | Description |
|------|-------------|
| `src/providers/implementations/gemini-audio-analysis.provider.ts` | Gemini Files API integration for audio |
| `src/providers/interfaces/audio-analysis.provider.ts` | Provider interface for audio analysis |

#### Types & Templates

| File | Description |
|------|-------------|
| `src/types/product-metadata.types.ts` | ProductMetadata, platform formats, Zod schemas |
| `src/templates/gemini-audio-analysis-prompt.ts` | System prompt for audio-to-metadata extraction |

#### Utilities

| File | Description |
|------|-------------|
| `src/utils/mime-types.ts` | MIME type detection for audio/video/image files |
| `src/utils/constants.ts` | APP_VERSION, PIPELINE_VERSION from package.json |
| `src/utils/parallel.ts` | Concurrent processing with concurrency limits |

#### Test Files

| File | Tests | Description |
|------|-------|-------------|
| `src/processors/impl/ffmpeg/extract-audio.test.ts` | 7 | Audio extraction tests |
| `src/processors/impl/gemini/gemini-audio-analysis.test.ts` | 11 | Audio analysis tests |
| `src/types/product-metadata.test.ts` | 53 | Metadata types and formatters |
| `src/utils/mime-types.test.ts` | 32 | MIME type utilities |
| `src/utils/constants.test.ts` | 6 | Version constants |
| `src/utils/parallel.test.ts` | 17 | Parallel processing |

### Files Modified

| File | Changes |
|------|---------|
| `src/config/env.ts` | Added `AUDIO_PROCESSING_TIMEOUT_MS`, `AUDIO_POLLING_INTERVAL_MS`, `AUDIO_MAX_RETRIES` |
| `src/config/index.ts` | Added `audio` config section |
| `src/processors/types.ts` | Added `audio`, `transcript`, `product.metadata` DataPaths, `AudioData` type |
| `src/processors/impl/db/complete-job.ts` | Uploads `metadata.json` to S3 with platform-formatted data |
| `src/processors/impl/index.ts` | Export `extractAudioProcessor`, `geminiAudioAnalysisProcessor` |
| `src/db/schema.ts` | Added `metadataS3Url` column to jobs table |

### New DataPaths

| DataPath | Description |
|----------|-------------|
| `audio` | Audio file data (path, format, duration, hasAudio) |
| `transcript` | Transcribed text from audio |
| `product.metadata` | Structured product metadata |

### New Processor IO Contracts

| Processor | requires | produces |
|-----------|----------|----------|
| `extract-audio` | `['video']` | `['audio']` |
| `gemini-audio-analysis` | `['audio']` | `['transcript', 'product.metadata']` |

### Product Metadata Output

The pipeline generates `metadata.json` in S3 containing:

```json
{
  "transcript": "Full audio transcription...",
  "product": {
    "title": "Product Name",
    "description": "Full description",
    "bulletPoints": ["Feature 1", "Feature 2"],
    "brand": "Brand Name",
    "materials": ["leather", "cotton"],
    "confidence": { "overall": 85, "title": 90, "description": 80 }
  },
  "platforms": {
    "shopify": { /* Shopify GraphQL format */ },
    "amazon": { /* SP-API format */ },
    "ebay": { /* Inventory API format */ }
  },
  "extractedAt": "2026-01-22T...",
  "audioDuration": 45.2,
  "pipelineVersion": "2.0.0"
}
```

### Platform Format Mapping

**Shopify**: `formatForShopify()`
- `title` → `title`
- `description` → `descriptionHtml`
- `brand` → `vendor`
- Weight units: `GRAMS`, `KILOGRAMS`, `POUNDS`, `OUNCES`

**Amazon**: `formatForAmazon()`
- `title` → `item_name`
- `bulletPoints` → `bullet_point` (max 5)
- `keywords` → `generic_keyword`
- Weight units: `grams`, `kilograms`, `pounds`, `ounces` (full names)

**eBay**: `formatForEbay()`
- `title` → `title` (max 80 chars, auto-truncated with logging)
- `itemSpecifics` → `aspects`
- Condition mapping: `new`→`NEW`, `refurbished`→`SELLER_REFURBISHED`, etc.

### Configuration

```bash
# Audio Processing
AUDIO_PROCESSING_TIMEOUT_MS=180000   # 3 minutes (Gemini file processing timeout)
AUDIO_POLLING_INTERVAL_MS=3000       # 3 seconds (polling interval)
AUDIO_MAX_RETRIES=3                  # Retry attempts for audio analysis
```

### Database Schema Update

```sql
-- Added to jobs table
metadata_s3_url TEXT  -- S3 URL to metadata.json (if audio analysis performed)
```

### Zod Validation Schema

The `geminiAudioAnalysisResponseSchema` validates Gemini responses with:
- Required: `transcript`, `product.title`, `product.description`, `confidence`
- Optional: `price`, `dimensions`, `weight`, `materials`, `colors`, `sizes`
- Defaults: `language='en'`, `relevantExcerpts=[]`, `bulletPoints=[]`

### Code Review Fixes Applied

| Issue | Fix |
|-------|-----|
| Missing parallel.ts tests | Added 17 comprehensive tests |
| Unsafe type assertion | Changed `e as Error` to `e instanceof Error ? e : new Error(String(e))` |
| itemSpecifics type incompatibility | Properly convert `string \| string[]` to `string[]` |
| Magic number for maxRetries | Added `AUDIO_MAX_RETRIES` to config |
| No stderr logging on success | Added debug logging for FFmpeg warnings |
| Repeated type assertions | Consolidated to `Required<ExtractAudioOptions>` object |

### Test Results

All **771 tests** passing across **40 test files** (126 new tests added).
