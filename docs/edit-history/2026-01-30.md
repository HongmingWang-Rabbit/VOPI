# Edit History - January 30, 2026

## Session Summary

Two features were implemented in this session:

1. **Shopify mandatory GDPR compliance webhooks** — Three new POST endpoints for `customers/data_request`, `customers/redact`, and `shop/redact`, verified via HMAC-SHA256 signature using the Shopify API secret. Since VOPI doesn't store customer data, all three acknowledge and return 200.

2. **Gemini Token Usage Tracker** — A new `TokenUsageTracker` utility that captures token usage (`promptTokenCount`, `candidatesTokenCount`) from every Gemini API call, accumulates usage per processor+model combination, and logs a summary table at the end of each pipeline run. This enables monitoring Gemini API costs per job.

---

## Shopify GDPR Compliance Webhooks

### Changes

1. **`src/services/oauth/shopify-oauth.service.ts`** — Added `verifyWebhookHmac(rawBody, hmacHeader)` method using HMAC-SHA256 base64 with timing-safe comparison
2. **`src/routes/webhooks.routes.ts`** — New file with 3 Shopify compliance webhook endpoints, shared handler factory, body schema for Swagger docs, and proper error logging for misconfigured Shopify credentials
3. **`src/middleware/auth.middleware.ts`** — Added `/api/v1/webhooks/shopify/` to `AUTH_SKIP_PATHS` (webhooks authenticated via HMAC, not API key)
4. **`src/app.ts`** — Registered `webhooksRoutes` with `/api/v1` prefix
5. **`shopify.app.vopi.toml`** — Added Shopify CLI app config with compliance webhook subscriptions (`customers/data_request`, `customers/redact`, `shop/redact`) pointing to `https://api.vopi.24rabbit.com/api/v1/webhooks/shopify`
6. **`shopify.app.toml`** — Default Shopify CLI config (generated by `shopify app config link`)

---

## Gemini Token Usage Tracker

### New Files

1. **`src/utils/token-usage.ts`** — `TokenUsageTracker` class with:
   - `record(model, processor, promptTokens, candidatesTokens)` — Accumulates usage per processor+model key
   - `getSummary(): TokenUsageSummary` — Returns entries and computed totals
   - `logSummary(jobId?)` — Logs structured summary via pino logger with optional job ID
   - `reset()` — Clears all entries
   - Exported interfaces: `TokenUsage`, `TokenUsageTotals`, `TokenUsageSummary`

2. **`src/utils/token-usage.test.ts`** — 10 unit tests covering record accumulation, separate tracking by processor+model, summary computation, reset, and logSummary behavior

### Modified Files — Core Infrastructure

3. **`src/processors/types.ts`** — Added optional `tokenUsage?: TokenUsageTracker` to `ProcessorContext` interface
4. **`src/processors/runner.ts`** — Stack runner creates a `TokenUsageTracker` at the start of `execute()` (reuses existing if present on context), attaches to context, and calls `logSummary(jobId)` after stack completion

### Modified Files — Provider Interfaces (contract updates)

5. **`src/providers/interfaces/audio-analysis.provider.ts`** — Added optional `tokenUsage?: TokenUsageTracker` param to `analyzeAudio()`
6. **`src/providers/interfaces/video-analysis.provider.ts`** — Added optional `tokenUsage?: TokenUsageTracker` param to `analyzeVideo()`
7. **`src/providers/interfaces/unified-video-analyzer.provider.ts`** — Added optional `tokenUsage?: TokenUsageTracker` param to `analyzeVideo()`
8. **`src/providers/interfaces/gemini-quality-filter.provider.ts`** — Added optional `tokenUsage?: TokenUsageTracker` param to `filterImages()`
9. **`src/providers/interfaces/gemini-image-generate.provider.ts`** — Added optional `tokenUsage?: TokenUsageTracker` param to `generateVariant()` and `generateAllVariants()`

### Modified Files — Provider Implementations (usage capture)

10. **`src/services/gemini.service.ts`** — Added optional `tokenUsage` param to `classifyFrames()`, captures `response.usageMetadata` after `generateContent()`
11. **`src/providers/implementations/gemini-audio-analysis.provider.ts`** — Added optional `tokenUsage` param to `analyzeAudio()`, captures usage
12. **`src/providers/implementations/gemini-video-analysis.provider.ts`** — Added optional `tokenUsage` param to `analyzeVideo()`, captures usage
13. **`src/providers/implementations/gemini-unified-video-analyzer.provider.ts`** — Added optional `tokenUsage` param to `analyzeVideo()`, captures usage
14. **`src/providers/implementations/gemini-quality-filter.provider.ts`** — Added optional `tokenUsage` param to `filterImages()`, captures usage
15. **`src/providers/implementations/gemini-image-generate.provider.ts`** — Added optional `tokenUsage` param to `generateVariant()` and `generateAllVariants()` (forwards to `generateVariant`), captures usage

### Modified Files — Processors (pass tracker to providers)

16. **`src/processors/impl/gemini/gemini-classify.ts`** — Passes `context.tokenUsage` to `geminiService.classifyFrames()`
17. **`src/processors/impl/gemini/gemini-audio-analysis.ts`** — Passes `context.tokenUsage` to `geminiAudioAnalysisProvider.analyzeAudio()`
18. **`src/processors/impl/gemini/gemini-video-analysis.ts`** — Passes `context.tokenUsage` to `geminiVideoAnalysisProvider.analyzeVideo()`
19. **`src/processors/impl/gemini/gemini-unified-video-analyzer.ts`** — Passes `context.tokenUsage` to `geminiUnifiedVideoAnalyzerProvider.analyzeVideo()`
20. **`src/processors/impl/gemini/gemini-quality-filter.ts`** — Passes `context.tokenUsage` to `geminiQualityFilterProvider.filterImages()`
21. **`src/processors/impl/gemini/gemini-image-generate.ts`** — Passes `context.tokenUsage` through `processFrame()` helper to `geminiImageGenerateProvider.generateVariant()`
